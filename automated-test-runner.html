<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automated Test System - Space Key Jump Tests</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
      }

      .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1em;
      }

      .content {
        padding: 30px;
      }

      .game-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }

      .game-canvas-container {
        flex: 1;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
        position: relative;
      }

      canvas {
        display: block;
        width: 100%;
        height: 400px;
      }

      .controls-panel {
        width: 300px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group h3 {
        margin: 0 0 10px 0;
        color: #495057;
        font-size: 1.1em;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px 5px 5px 0;
        transition: background-color 0.2s;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn.btn-success {
        background: #28a745;
      }

      .btn.btn-success:hover {
        background: #1e7e34;
      }

      .btn.btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn.btn-warning:hover {
        background: #e0a800;
      }

      .btn.btn-danger {
        background: #dc3545;
      }

      .btn.btn-danger:hover {
        background: #c82333;
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .test-results {
        margin-top: 30px;
      }

      .test-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }

      .test-section h3 {
        margin: 0 0 15px 0;
        color: #495057;
      }

      .test-item {
        background: white;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #28a745;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .test-item.failed {
        border-left-color: #dc3545;
      }

      .test-item.error {
        border-left-color: #ffc107;
      }

      .test-item h4 {
        margin: 0 0 10px 0;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .test-status {
        font-size: 1.2em;
      }

      .test-status.success {
        color: #28a745;
      }

      .test-status.failed {
        color: #dc3545;
      }

      .test-status.error {
        color: #ffc107;
      }

      .test-details {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 10px;
      }

      .test-summary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      .test-summary.failed {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      }

      .summary-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
      }

      .summary-stat {
        text-align: center;
      }

      .summary-stat .number {
        font-size: 2em;
        font-weight: bold;
        display: block;
      }

      .summary-stat .label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .log-output {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-entry.info {
        color: #63b3ed;
      }

      .log-entry.success {
        color: #68d391;
      }

      .log-entry.warning {
        color: #fbb040;
      }

      .log-entry.error {
        color: #fc8181;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        width: 0%;
        transition: width 0.3s ease;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.running {
        background: #ffc107;
        animation: pulse 1s infinite;
      }

      .status-indicator.success {
        background: #28a745;
      }

      .status-indicator.failed {
        background: #dc3545;
      }

      .status-indicator.idle {
        background: #6c757d;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .metric-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
      }

      .metric-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #007bff;
        display: block;
      }

      .metric-label {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
      }

      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .alert.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .alert.warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      .alert.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üß™ Automated Test System</h1>
        <p>Space Key Jump Functionality Testing Suite</p>
      </div>

      <div class="content">
        <div class="alert info">
          <strong>„ÉÜ„Çπ„ÉàÊ¶ÇË¶Å:</strong>
          „Åì„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÅØ„Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÅÆ„Ç∏„É£„É≥„ÉóÊ©üËÉΩ„ÇíËá™ÂãïÁöÑ„Å´„ÉÜ„Çπ„Éà„Åó„ÄÅÂõûÂ∏∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ
          ÂêÑ„ÉÜ„Çπ„Éà„ÅØÂÆüÈöõ„ÅÆ„Ç≠„Éº„Ç§„Éô„É≥„Éà„Çí„Ç∑„Éü„É•„É¨„Éº„Éà„Åó„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅÆÂãï‰Ωú„ÇíÊ§úË®º„Åó„Åæ„Åô„ÄÇ
        </div>

        <div class="game-container">
          <div class="game-canvas-container">
            <canvas id="gameCanvas" width="800" height="400"></canvas>
          </div>

          <div class="controls-panel">
            <div class="control-group">
              <h3>üéÆ Game Controls</h3>
              <button class="btn btn-success" onclick="startGame()">
                Start Game
              </button>
              <button class="btn btn-warning" onclick="pauseGame()">
                Pause
              </button>
              <button class="btn btn-danger" onclick="stopGame()">Stop</button>
            </div>

            <div class="control-group">
              <h3>üß™ Test Controls</h3>
              <button class="btn" onclick="runJumpVerificationTests()">
                Jump Tests
              </button>
              <button class="btn" onclick="runRegressionTests()">
                Regression Tests
              </button>
              <button class="btn btn-success" onclick="runAllTests()">
                Run All Tests
              </button>
            </div>

            <div class="control-group">
              <h3>üîß Simulation</h3>
              <button class="btn" onclick="simulateSpaceKey()">
                Simulate Space Key
              </button>
              <button class="btn" onclick="testInputLatency()">
                Test Latency
              </button>
              <button class="btn" onclick="testConsistency()">
                Test Consistency
              </button>
            </div>

            <div class="control-group">
              <h3>üìä Status</h3>
              <div id="testStatus">
                <span class="status-indicator idle"></span>
                <span>Ready</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="test-results" id="testResults">
          <!-- Test results will be populated here -->
        </div>

        <div class="log-output" id="logOutput">
          <div class="log-entry info">
            System initialized. Ready for testing.
          </div>
        </div>
      </div>
    </div>

    <!-- Game Engine Scripts -->
    <script src="js/physics-engine.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/player.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/item.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/main.js"></script>

    <!-- Enhanced Input Systems -->
    <script src="js/input-diagnostic-system.js"></script>
    <script src="js/focus-manager.js"></script>
    <script src="js/enhanced-input-manager.js"></script>
    <script src="js/compatibility-layer.js"></script>
    <script src="js/fallback-input-system.js"></script>

    <!-- Test Systems -->
    <script src="js/test-runner.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/automated-test-system.js"></script>

    <script>
      let gameEngine = null;
      let automatedTestSystem = null;
      let currentTestRun = null;

      // Initialize the game and test system
      async function initializeSystem() {
        try {
          const canvas = document.getElementById("gameCanvas");
          const ctx = canvas.getContext("2d");

          // Initialize game engine
          gameEngine = new GameEngine(canvas, ctx);
          await gameEngine.initialize();

          // Initialize automated test system
          automatedTestSystem = new AutomatedTestSystem(gameEngine);

          logMessage("System initialized successfully", "success");
          updateStatus("Ready", "idle");
        } catch (error) {
          logMessage(`Initialization failed: ${error.message}`, "error");
          updateStatus("Error", "failed");
        }
      }

      // Game control functions
      function startGame() {
        if (gameEngine) {
          gameEngine.startGame();
          logMessage("Game started", "info");
          updateStatus("Game Running", "success");
        }
      }

      function pauseGame() {
        if (gameEngine) {
          gameEngine.togglePause();
          logMessage("Game paused/resumed", "info");
        }
      }

      function stopGame() {
        if (gameEngine) {
          gameEngine.stopGame();
          logMessage("Game stopped", "info");
          updateStatus("Game Stopped", "idle");
        }
      }

      // Test execution functions
      async function runJumpVerificationTests() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        updateStatus("Running Jump Tests", "running");
        logMessage("Starting jump verification tests...", "info");

        try {
          const results = await automatedTestSystem.runJumpVerificationTests();
          displayTestResults("Jump Verification Tests", results);

          const successRate =
            (results.summary.passed / results.summary.total) * 100;
          logMessage(
            `Jump tests completed: ${successRate.toFixed(1)}% success rate`,
            "success"
          );
          updateStatus("Jump Tests Complete", "success");
        } catch (error) {
          logMessage(`Jump tests failed: ${error.message}`, "error");
          updateStatus("Jump Tests Failed", "failed");
        }
      }

      async function runRegressionTests() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        updateStatus("Running Regression Tests", "running");
        logMessage("Starting regression test suite...", "info");

        try {
          const results = await automatedTestSystem.buildRegressionTestSuite();
          displayRegressionResults(results);

          const successRate = results.summary.successRate;
          logMessage(
            `Regression tests completed: ${successRate.toFixed(
              1
            )}% success rate`,
            "success"
          );

          if (results.summary.regressionDetected) {
            logMessage("‚ö†Ô∏è Regression detected!", "warning");
            updateStatus("Regression Detected", "failed");
          } else {
            logMessage("‚úÖ No regression detected", "success");
            updateStatus("Regression Tests Passed", "success");
          }
        } catch (error) {
          logMessage(`Regression tests failed: ${error.message}`, "error");
          updateStatus("Regression Tests Failed", "failed");
        }
      }

      async function runAllTests() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        updateStatus("Running All Tests", "running");
        logMessage("Starting comprehensive test suite...", "info");

        try {
          const results = await automatedTestSystem.runAllAutomatedTests();

          // Display jump verification results
          if (results.jumpVerificationTests) {
            displayTestResults(
              "Jump Verification Tests",
              results.jumpVerificationTests
            );
          }

          // Display regression results
          if (results.regressionTests) {
            displayRegressionResults(results.regressionTests);
          }

          logMessage(`All tests completed in ${results.duration}ms`, "success");
          updateStatus("All Tests Complete", "success");
        } catch (error) {
          logMessage(`Test suite failed: ${error.message}`, "error");
          updateStatus("Test Suite Failed", "failed");
        }
      }

      // Simulation functions
      async function simulateSpaceKey() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        logMessage("Simulating space key press...", "info");

        try {
          const result = await automatedTestSystem.simulateSpaceKeyInput({
            repeat: 1,
            duration: 100,
          });

          if (result.success) {
            logMessage("Space key simulation successful", "success");
          } else {
            logMessage(
              `Space key simulation failed: ${result.errors.join(", ")}`,
              "error"
            );
          }
        } catch (error) {
          logMessage(`Simulation error: ${error.message}`, "error");
        }
      }

      async function testInputLatency() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        logMessage("Testing input latency...", "info");

        try {
          const result = await automatedTestSystem.testInputLatency();

          if (result.success) {
            logMessage(
              `Input latency test passed: ${result.details.averageLatency}ms average`,
              "success"
            );
          } else {
            logMessage(
              `Input latency test failed: ${result.message}`,
              "warning"
            );
          }
        } catch (error) {
          logMessage(`Latency test error: ${error.message}`, "error");
        }
      }

      async function testConsistency() {
        if (!automatedTestSystem) {
          logMessage("Test system not initialized", "error");
          return;
        }

        logMessage("Testing jump consistency...", "info");

        try {
          const result =
            await automatedTestSystem.testMultipleJumpConsistency();

          if (result.success) {
            logMessage(
              `Consistency test passed: ${result.details.successRate}% success rate`,
              "success"
            );
          } else {
            logMessage(`Consistency test failed: ${result.message}`, "warning");
          }
        } catch (error) {
          logMessage(`Consistency test error: ${error.message}`, "error");
        }
      }

      // UI helper functions
      function displayTestResults(suiteName, results) {
        const resultsContainer = document.getElementById("testResults");

        const successRate =
          (results.summary.passed / results.summary.total) * 100;
        const isSuccess =
          results.summary.failed === 0 && results.summary.errors === 0;

        const summaryHtml = `
                <div class="test-summary ${isSuccess ? "" : "failed"}">
                    <h3>${suiteName} Results</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="number">${results.summary.total}</span>
                            <span class="label">Total Tests</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${
                              results.summary.passed
                            }</span>
                            <span class="label">Passed</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${
                              results.summary.failed
                            }</span>
                            <span class="label">Failed</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${successRate.toFixed(
                              1
                            )}%</span>
                            <span class="label">Success Rate</span>
                        </div>
                    </div>
                </div>
            `;

        const testsHtml = results.tests
          .map(
            (test) => `
                <div class="test-item ${test.success ? "" : "failed"}">
                    <h4>
                        <span class="test-status ${
                          test.success ? "success" : "failed"
                        }">
                            ${test.success ? "‚úÖ" : "‚ùå"}
                        </span>
                        ${test.name}
                        <small>(${test.duration}ms)</small>
                    </h4>
                    <p>${test.message}</p>
                    ${
                      test.details && Object.keys(test.details).length > 0
                        ? `
                        <div class="test-details">
                            <strong>Details:</strong> ${JSON.stringify(
                              test.details,
                              null,
                              2
                            )}
                        </div>
                    `
                        : ""
                    }
                </div>
            `
          )
          .join("");

        const sectionHtml = `
                <div class="test-section">
                    ${summaryHtml}
                    <h3>Test Details</h3>
                    ${testsHtml}
                </div>
            `;

        resultsContainer.innerHTML = sectionHtml + resultsContainer.innerHTML;
      }

      function displayRegressionResults(results) {
        const resultsContainer = document.getElementById("testResults");

        const isSuccess = !results.summary.regressionDetected;
        const successRate = results.summary.successRate;

        const summaryHtml = `
                <div class="test-summary ${isSuccess ? "" : "failed"}">
                    <h3>Regression Test Results</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="number">${
                              results.summary.totalTests
                            }</span>
                            <span class="label">Total Tests</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${
                              results.summary.totalPassed
                            }</span>
                            <span class="label">Passed</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${
                              results.summary.totalFailed
                            }</span>
                            <span class="label">Failed</span>
                        </div>
                        <div class="summary-stat">
                            <span class="number">${successRate.toFixed(
                              1
                            )}%</span>
                            <span class="label">Success Rate</span>
                        </div>
                    </div>
                    ${
                      results.summary.regressionDetected
                        ? `
                        <div class="alert error" style="margin-top: 15px;">
                            <strong>Regression Detected!</strong>
                            Current: ${results.regressionDetails.currentSuccessRate.toFixed(
                              1
                            )}% |
                            Baseline: ${results.regressionDetails.baselineSuccessRate.toFixed(
                              1
                            )}% |
                            Degradation: ${results.regressionDetails.degradation.toFixed(
                              1
                            )}%
                        </div>
                    `
                        : ""
                    }
                </div>
            `;

        const suitesHtml = results.testSuites
          .map(
            (suite) => `
                <div class="test-item">
                    <h4>
                        <span class="test-status ${
                          suite.summary.failed === 0 ? "success" : "failed"
                        }">
                            ${suite.summary.failed === 0 ? "‚úÖ" : "‚ùå"}
                        </span>
                        ${suite.name}
                    </h4>
                    <p>Tests: ${suite.summary.total} | Passed: ${
              suite.summary.passed
            } | Failed: ${suite.summary.failed}</p>
                </div>
            `
          )
          .join("");

        const sectionHtml = `
                <div class="test-section">
                    ${summaryHtml}
                    <h3>Test Suites</h3>
                    ${suitesHtml}
                </div>
            `;

        resultsContainer.innerHTML = sectionHtml + resultsContainer.innerHTML;
      }

      function logMessage(message, type = "info") {
        const logOutput = document.getElementById("logOutput");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;

        logOutput.appendChild(logEntry);
        logOutput.scrollTop = logOutput.scrollHeight;
      }

      function updateStatus(message, type = "idle") {
        const statusElement = document.getElementById("testStatus");
        const indicator = statusElement.querySelector(".status-indicator");
        const text = statusElement.querySelector("span:last-child");

        indicator.className = `status-indicator ${type}`;
        text.textContent = message;
      }

      function updateProgress(percentage) {
        const progressFill = document.getElementById("progressFill");
        progressFill.style.width = `${percentage}%`;
      }

      // Initialize system when page loads
      window.addEventListener("load", initializeSystem);

      // Handle keyboard events for manual testing
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          logMessage("Manual space key detected", "info");
        }
      });
    </script>
  </body>
</html>
