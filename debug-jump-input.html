<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jump Input Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f0f0f0;
      }

      .debug-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 10px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 15px;
        margin: 5px;
        font-weight: bold;
      }

      .active {
        background: #28a745;
        color: white;
      }
      .inactive {
        background: #6c757d;
        color: white;
      }

      .log {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>üêõ Jump Input Debug Tool</h1>

    <div class="debug-panel">
      <h2>Input Manager Status</h2>
      <div id="input-status">
        <div class="status inactive" id="space-key">Space Key</div>
        <div class="status inactive" id="up-arrow">Up Arrow</div>
        <div class="status inactive" id="w-key">W Key</div>
        <div class="status inactive" id="enter-key">Enter Key</div>
      </div>
    </div>

    <div class="debug-panel">
      <h2>Action States</h2>
      <div id="action-status">
        <div class="status inactive" id="jump-action">Jump Action</div>
        <div class="status inactive" id="jump-pressed">Jump Pressed</div>
        <div class="status inactive" id="jump-held">Jump Held</div>
      </div>
    </div>

    <div class="debug-panel">
      <h2>Fallback Input Status</h2>
      <div id="fallback-status">
        <div class="status inactive" id="fallback-jump">Fallback Jump</div>
        <div class="status inactive" id="fallback-integrated">
          Fallback Integrated
        </div>
      </div>
    </div>

    <div class="debug-panel">
      <h2>Test Controls</h2>
      <button onclick="testSpaceKey()">Test Space Key</button>
      <button onclick="testUpArrow()">Test Up Arrow</button>
      <button onclick="testWKey()">Test W Key</button>
      <button onclick="testEnterKey()">Test Enter Key</button>
      <button onclick="testFallbackJump()">Test Fallback Jump</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="debug-panel">
      <h2>Debug Log</h2>
      <div id="debug-log" class="log">Initializing debug tool...\n</div>
    </div>

    <!-- Load required scripts -->
    <script src="js/focus-manager.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/fallback-input-system.js"></script>

    <script>
      let inputManager, fallbackInputSystem, gameEngine;

      // Initialize debug environment
      function init() {
        log("üîß Initializing debug environment...");

        // Create mock canvas
        const canvas = document.createElement("canvas");
        canvas.width = 800;
        canvas.height = 600;
        canvas.style.display = "none";
        document.body.appendChild(canvas);

        // Create mock game engine
        gameEngine = {
          canvas: canvas,
          inputManager: new InputManager(canvas),
        };

        inputManager = gameEngine.inputManager;

        // Initialize fallback input system
        try {
          fallbackInputSystem = new FallbackInputSystem(gameEngine);
          log("‚úÖ FallbackInputSystem initialized");
          updateStatus("fallback-integrated", true);
        } catch (error) {
          log("‚ùå Failed to initialize FallbackInputSystem: " + error.message);
          updateStatus("fallback-integrated", false);
        }

        // Start monitoring
        startMonitoring();

        log("üéÆ Debug environment ready!");
        log("Press any jump key or use test buttons to debug input...");
      }

      // Start input monitoring
      function startMonitoring() {
        setInterval(() => {
          if (!inputManager) return;

          // Update input manager
          inputManager.update();

          // Check key states
          updateStatus("space-key", inputManager.isKeyHeld("Space"));
          updateStatus("up-arrow", inputManager.isKeyHeld("ArrowUp"));
          updateStatus("w-key", inputManager.isKeyHeld("KeyW"));
          updateStatus("enter-key", inputManager.isKeyHeld("Enter"));

          // Check action states
          const input = inputManager.getPlayerInput();
          updateStatus("jump-action", input.jump);
          updateStatus("jump-pressed", inputManager.isActionPressed("jump"));
          updateStatus("jump-held", inputManager.isActionHeld("jump"));

          // Check fallback state
          if (fallbackInputSystem) {
            updateStatus(
              "fallback-jump",
              fallbackInputSystem.fallbackState.jumpPressed
            );
          }
        }, 16); // ~60fps

        // Listen for key events
        document.addEventListener("keydown", (e) => {
          log(`üîë KeyDown: ${e.code} (${e.key})`);

          // Check if it's a jump key
          const jumpKeys = ["Space", "ArrowUp", "KeyW", "Enter"];
          if (jumpKeys.includes(e.code)) {
            log(`  ‚Ü≥ Jump key detected!`);

            // Check input manager response
            setTimeout(() => {
              const input = inputManager.getPlayerInput();
              log(
                `  ‚Ü≥ InputManager response: jump=${
                  input.jump
                }, jumpPressed=${inputManager.isActionPressed("jump")}`
              );

              if (fallbackInputSystem) {
                log(
                  `  ‚Ü≥ Fallback state: jumpPressed=${fallbackInputSystem.fallbackState.jumpPressed}`
                );
              }
            }, 10);
          }
        });

        document.addEventListener("keyup", (e) => {
          log(`üîë KeyUp: ${e.code} (${e.key})`);
        });
      }

      // Test functions
      function testSpaceKey() {
        log("üß™ Testing Space key...");
        simulateKeyPress("Space", " ");
      }

      function testUpArrow() {
        log("üß™ Testing Up Arrow key...");
        simulateKeyPress("ArrowUp", "ArrowUp");
      }

      function testWKey() {
        log("üß™ Testing W key...");
        simulateKeyPress("KeyW", "w");
      }

      function testEnterKey() {
        log("üß™ Testing Enter key...");
        simulateKeyPress("Enter", "Enter");
      }

      function testFallbackJump() {
        log("üß™ Testing Fallback Jump...");
        if (fallbackInputSystem) {
          fallbackInputSystem.handleFallbackJump(true);
          setTimeout(() => {
            fallbackInputSystem.handleFallbackJump(false);
            log("  ‚Ü≥ Fallback jump completed");
          }, 100);
        } else {
          log("  ‚ùå FallbackInputSystem not available");
        }
      }

      // Simulate key press
      function simulateKeyPress(code, key) {
        const keyDownEvent = new KeyboardEvent("keydown", {
          code: code,
          key: key,
          bubbles: true,
        });

        const keyUpEvent = new KeyboardEvent("keyup", {
          code: code,
          key: key,
          bubbles: true,
        });

        document.dispatchEvent(keyDownEvent);
        log(`  ‚Ü≥ Dispatched keydown for ${code}`);

        setTimeout(() => {
          document.dispatchEvent(keyUpEvent);
          log(`  ‚Ü≥ Dispatched keyup for ${code}`);

          // Check final state
          setTimeout(() => {
            const input = inputManager.getPlayerInput();
            log(`  ‚Ü≥ Final state: jump=${input.jump}`);
          }, 20);
        }, 100);
      }

      // Update status indicator
      function updateStatus(elementId, active) {
        const element = document.getElementById(elementId);
        if (element) {
          element.className = `status ${active ? "active" : "inactive"}`;
        }
      }

      // Log function
      function log(message) {
        const logElement = document.getElementById("debug-log");
        const timestamp = new Date().toLocaleTimeString();
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Clear log
      function clearLog() {
        document.getElementById("debug-log").textContent = "";
        log("Debug log cleared");
      }

      // Initialize when page loads
      window.addEventListener("load", init);
    </script>
  </body>
</html>
