<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å…ƒã‚²ãƒ¼ãƒ  ãƒ‡ãƒãƒƒã‚°ç‰ˆ</title>
    <link rel="stylesheet" href="styles/main.css" />
    <style>
      #debug-overlay {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
      }

      #debug-overlay button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin: 2px;
        font-size: 11px;
      }

      #debug-overlay button:hover {
        background: #1976d2;
      }

      .debug-section {
        margin: 10px 0;
        padding: 5px;
        border: 1px solid #444;
        border-radius: 3px;
      }

      .status-good {
        color: #4caf50;
      }
      .status-bad {
        color: #f44336;
      }
      .status-warning {
        color: #ff9800;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <canvas id="game-canvas" width="800" height="600" tabindex="0"></canvas>
      <div id="ui-overlay">
        <div id="hud" class="hidden">
          <div id="score">Score: <span id="score-value">0</span></div>
          <div id="coins">Coins: <span id="coin-value">0</span></div>
          <div id="lives">Lives: <span id="lives-value">3</span></div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="debug-overlay">
      <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>

      <div class="debug-section">
        <strong>ã‚²ãƒ¼ãƒ çŠ¶æ…‹:</strong><br />
        ãƒ¢ãƒ¼ãƒ‰: <span id="game-mode">-</span><br />
        FPS: <span id="fps-display">-</span>
      </div>

      <div class="debug-section">
        <strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:</strong><br />
        ä½ç½®: <span id="player-pos">-</span><br />
        é€Ÿåº¦: <span id="player-vel">-</span><br />
        åœ°é¢: <span id="player-ground">-</span><br />
        çŠ¶æ…‹: <span id="player-state">-</span>
      </div>

      <div class="debug-section">
        <strong>å…¥åŠ›:</strong><br />
        æœ€å¾Œã®ã‚­ãƒ¼: <span id="last-key">-</span><br />
        ã‚¸ãƒ£ãƒ³ãƒ—æ¤œå‡º: <span id="jump-detected">-</span><br />
        å…¥åŠ›çŠ¶æ…‹: <span id="input-state">-</span>
      </div>

      <div class="debug-section">
        <button onclick="forceStartGame()">ğŸ® ã‚²ãƒ¼ãƒ å¼·åˆ¶é–‹å§‹</button>
        <button onclick="debugJump()">ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ</button><br />
        <button onclick="forceJump()">ğŸ’ª å¼·åˆ¶ã‚¸ãƒ£ãƒ³ãƒ—</button>
        <button onclick="resetPlayer()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button><br />
        <button onclick="toggleDebug()">ğŸ“Š è©³ç´°ãƒ­ã‚°</button>
      </div>

      <div class="debug-section">
        <strong>ãƒ­ã‚°:</strong><br />
        <div
          id="debug-log"
          style="
            max-height: 100px;
            overflow-y: auto;
            background: #222;
            padding: 5px;
            border-radius: 3px;
            font-size: 10px;
          "
        ></div>
      </div>
    </div>

    <!-- å…ƒã®ã‚²ãƒ¼ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/focus-manager.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/player.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/fallback-input-system.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/jump-diagnostic-system.js"></script>
    <script src="js/debug-display-system.js"></script>
    <script src="js/main.js"></script>

    <script>
      // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
      let debugLogElement = null;
      let detailedLogging = false;

      function debugLog(message) {
        console.log(message);
        if (debugLogElement) {
          const timestamp = new Date().toLocaleTimeString();
          debugLogElement.innerHTML += `[${timestamp}] ${message}\n`;
          debugLogElement.scrollTop = debugLogElement.scrollHeight;
        }
      }

      function debugJump() {
        if (window.gameEngine && window.gameEngine.player) {
          const player = window.gameEngine.player;
          const gameMode = window.gameEngine.gameState?.mode || "unknown";

          debugLog(`ğŸ§ª ãƒ‡ãƒãƒƒã‚°ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ:`);
          debugLog(`  ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰: ${gameMode}`);
          debugLog(`  åœ°é¢: ${player.isOnGround}`);
          debugLog(`  ãƒ–ãƒ­ãƒƒã‚¯ä¸­: ${player.isBlocking}`);
          debugLog(`  çŠ¶æ…‹: ${player.state}`);
          debugLog(
            `  ä½ç½®: ${player.position.x.toFixed(
              1
            )}, ${player.position.y.toFixed(1)}`
          );
          debugLog(
            `  é€Ÿåº¦: ${player.velocity.x.toFixed(
              1
            )}, ${player.velocity.y.toFixed(1)}`
          );

          // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãŒ playing ã§ãªã„å ´åˆã¯å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆ
          if (gameMode !== "playing") {
            debugLog(
              `âš ï¸ ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãŒ ${gameMode} ã§ã™ã€‚playingã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚`
            );
            window.gameEngine.startGame();
            debugLog(`âœ… ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’ playing ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
          }

          const result = player.jump();
          debugLog(`  çµæœ: ${result ? "æˆåŠŸ" : "å¤±æ•—"}`);
          return result;
        }
        debugLog("âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function forceJump() {
        if (window.gameEngine && window.gameEngine.player) {
          const player = window.gameEngine.player;
          const gameMode = window.gameEngine.gameState?.mode || "unknown";

          debugLog(`ğŸ’ª å¼·åˆ¶ã‚¸ãƒ£ãƒ³ãƒ—å®Ÿè¡Œ`);
          debugLog(`  ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰: ${gameMode}`);

          // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’ playing ã«å¼·åˆ¶å¤‰æ›´
          if (gameMode !== "playing") {
            debugLog(`  ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’ playing ã«å¤‰æ›´ä¸­...`);
            window.gameEngine.startGame();
          }

          // å¼·åˆ¶çš„ã«åœ°é¢ã«é…ç½®
          debugLog(`  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°é¢ã«é…ç½®ä¸­...`);
          player.position.y = 518;
          player.velocity.y = 0;
          player.isOnGround = true;
          player.isBlocking = false;
          player.state = "idle";

          debugLog(
            `  ã‚¸ãƒ£ãƒ³ãƒ—å‰ã®çŠ¶æ…‹: ä½ç½®=${player.position.y}, é€Ÿåº¦=${player.velocity.y}, åœ°é¢=${player.isOnGround}`
          );

          const result = player.jump();

          debugLog(
            `  ã‚¸ãƒ£ãƒ³ãƒ—å¾Œã®çŠ¶æ…‹: ä½ç½®=${player.position.y}, é€Ÿåº¦=${player.velocity.y}, åœ°é¢=${player.isOnGround}`
          );
          debugLog(`  çµæœ: ${result ? "æˆåŠŸ" : "å¤±æ•—"}`);

          // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
          setTimeout(() => {
            debugLog(
              `  1ç§’å¾Œã®çŠ¶æ…‹: ä½ç½®=${player.position.y.toFixed(
                1
              )}, é€Ÿåº¦=${player.velocity.y.toFixed(1)}`
            );
          }, 1000);

          return result;
        }
        debugLog("âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function resetPlayer() {
        if (window.gameEngine && window.gameEngine.player) {
          const player = window.gameEngine.player;
          player.position = { x: 100, y: 400 };
          player.velocity = { x: 0, y: 0 };
          player.isOnGround = true;
          player.isBlocking = false;
          player.state = "idle";
          debugLog("ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†");
          return true;
        }
        debugLog("âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function toggleDebug() {
        detailedLogging = !detailedLogging;
        debugLog(`ğŸ“Š è©³ç´°ãƒ­ã‚°: ${detailedLogging ? "ON" : "OFF"}`);
        return detailedLogging;
      }

      function forceStartGame() {
        if (window.gameEngine) {
          const currentMode = window.gameEngine.gameState?.mode || "unknown";
          debugLog(`ğŸ® ã‚²ãƒ¼ãƒ å¼·åˆ¶é–‹å§‹:`);
          debugLog(`  ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: ${currentMode}`);

          // å¼·åˆ¶çš„ã«ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
          window.gameEngine.startGame();

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é©åˆ‡ãªä½ç½®ã«é…ç½®
          if (window.gameEngine.player) {
            window.gameEngine.player.position = { x: 100, y: 400 };
            window.gameEngine.player.velocity = { x: 0, y: 0 };
            window.gameEngine.player.isOnGround = true;
            window.gameEngine.player.isBlocking = false;
            window.gameEngine.player.state = "idle";
          }

          const newMode = window.gameEngine.gameState?.mode || "unknown";
          debugLog(`  æ–°ã—ã„ãƒ¢ãƒ¼ãƒ‰: ${newMode}`);
          debugLog(`âœ… ã‚²ãƒ¼ãƒ é–‹å§‹å®Œäº†`);

          return newMode === "playing";
        }
        debugLog("âŒ ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
      function updateDebugInfo() {
        if (!window.gameEngine) return;

        const engine = window.gameEngine;
        const player = engine.player;
        const inputManager = engine.inputManager;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        document.getElementById("game-mode").textContent =
          engine.gameState?.mode || "-";
        document.getElementById("fps-display").textContent = engine.fps || "-";

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
        if (player) {
          document.getElementById("player-pos").textContent = `${Math.round(
            player.position.x
          )}, ${Math.round(player.position.y)}`;
          document.getElementById("player-vel").textContent = `${Math.round(
            player.velocity.x
          )}, ${Math.round(player.velocity.y)}`;

          const groundElement = document.getElementById("player-ground");
          if (player.isOnGround) {
            groundElement.textContent = "ã¯ã„";
            groundElement.className = "status-good";
          } else {
            groundElement.textContent = "ã„ã„ãˆ";
            groundElement.className = "status-bad";
          }

          document.getElementById("player-state").textContent = player.state;
        }

        // å…¥åŠ›æƒ…å ±
        if (inputManager) {
          const input = inputManager.getPlayerInput();

          document.getElementById("last-key").textContent =
            inputManager.lastKeyPressed || "-";

          const jumpElement = document.getElementById("jump-detected");
          if (input.jump) {
            jumpElement.textContent = "ã¯ã„";
            jumpElement.className = "status-good";
          } else {
            jumpElement.textContent = "ã„ã„ãˆ";
            jumpElement.className = "status-bad";
          }

          const activeInputs = [];
          if (input.jump) activeInputs.push("JUMP");
          if (input.moveLeft) activeInputs.push("LEFT");
          if (input.moveRight) activeInputs.push("RIGHT");
          document.getElementById("input-state").textContent =
            activeInputs.join(", ") || "ãªã—";
        }
      }

      // åˆæœŸåŒ–
      window.addEventListener("load", () => {
        debugLogElement = document.getElementById("debug-log");
        debugLog("ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆæœŸåŒ–å®Œäº†");

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å®šæœŸæ›´æ–°
        setInterval(updateDebugInfo, 100);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.debugJump = debugJump;
        window.forceJump = forceJump;
        window.resetPlayer = resetPlayer;
        window.toggleDebug = toggleDebug;
        window.forceStartGame = forceStartGame;

        debugLog("ğŸ® å…ƒã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒãƒƒã‚°ç‰ˆæº–å‚™å®Œäº†");
      });

      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨
      window.addEventListener("keydown", (e) => {
        if (detailedLogging) {
          debugLog(`âŒ¨ï¸ ã‚­ãƒ¼æŠ¼ä¸‹: ${e.code}`);
        }
      });
    </script>
  </body>
</html>
