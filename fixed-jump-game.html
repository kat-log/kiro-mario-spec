<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¿®æ­£ç‰ˆ Mario Style Platformer</title>
    <link rel="stylesheet" href="styles/main.css" />
    <style>
      /* è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      #game-instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        text-align: center;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        z-index: 100;
      }

      #game-instructions.hidden {
        display: none;
      }

      .jump-indicator {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: yellow;
        font-size: 16px;
        font-weight: bold;
        background: rgba(0, 0, 0, 0.7);
        padding: 5px 10px;
        border-radius: 5px;
        z-index: 50;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <canvas id="game-canvas" width="800" height="600" tabindex="0"></canvas>

      <!-- ã‚²ãƒ¼ãƒ é–‹å§‹æŒ‡ç¤º -->
      <div id="game-instructions">
        <h2>ğŸ® Mario Style Platformer</h2>
        <p><strong>æ“ä½œæ–¹æ³•:</strong></p>
        <p>ğŸƒ ç§»å‹•: â†â†’ ã¾ãŸã¯ A/D</p>
        <p>ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—: ã‚¹ãƒšãƒ¼ã‚¹ ã¾ãŸã¯ â†‘ ã¾ãŸã¯ W ã¾ãŸã¯ Enter</p>
        <p>â¸ï¸ ãƒãƒ¼ã‚º: P</p>
        <p>ğŸšª ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹: Escape</p>
        <br />
        <p><strong>ğŸ¯ ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¾ãŸã¯Enterã§ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</strong></p>
      </div>

      <!-- ã‚¸ãƒ£ãƒ³ãƒ—çŠ¶æ…‹è¡¨ç¤º -->
      <div id="jump-indicator" class="jump-indicator hidden">ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ï¼</div>

      <div id="ui-overlay">
        <div id="hud" class="hidden">
          <div id="score">Score: <span id="score-value">0</span></div>
          <div id="coins">Coins: <span id="coin-value">0</span></div>
          <div id="lives">Lives: <span id="lives-value">3</span></div>
        </div>
      </div>
    </div>

    <!-- å¿…è¦ãªJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/focus-manager.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/player.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/fallback-input-system.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/jump-diagnostic-system.js"></script>
    <script src="js/debug-display-system.js"></script>

    <script>
      // ä¿®æ­£ç‰ˆã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³
      class FixedGameEngine {
        constructor() {
          this.canvas = document.getElementById("game-canvas");
          this.ctx = this.canvas.getContext("2d");

          // UIè¦ç´ 
          this.instructionsElement =
            document.getElementById("game-instructions");
          this.jumpIndicator = document.getElementById("jump-indicator");
          this.hudElement = document.getElementById("hud");

          // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
          this.gameState = {
            mode: "menu", // 'menu', 'playing', 'paused'
            isRunning: false,
          };

          // ã‚¿ã‚¤ãƒŸãƒ³ã‚°
          this.lastFrameTime = 0;
          this.fps = 0;
          this.frameCount = 0;
          this.fpsUpdateTime = 0;

          // ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          this.inputManager = null;
          this.physicsEngine = null;
          this.player = null;
          this.stage = null;

          // ã‚¸ãƒ£ãƒ³ãƒ—è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼
          this.jumpIndicatorTimer = 0;

          console.log("ğŸ® ä¿®æ­£ç‰ˆã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­...");
          this.init();
        }

        async init() {
          try {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¢ºä¿
            this.canvas.focus();

            // å…¥åŠ›ç®¡ç†åˆæœŸåŒ–
            this.inputManager = new InputManager(this.canvas);
            console.log("âœ… InputManageråˆæœŸåŒ–å®Œäº†");

            // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
            this.physicsEngine = new PhysicsEngine();
            console.log("âœ… PhysicsEngineåˆæœŸåŒ–å®Œäº†");

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
            this.player = new Player(100, 400);
            console.log("âœ… PlayeråˆæœŸåŒ–å®Œäº†");

            // ã‚¹ãƒ†ãƒ¼ã‚¸åˆæœŸåŒ–
            this.stage = new Stage();
            console.log("âœ… StageåˆæœŸåŒ–å®Œäº†");

            // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
            this.gameState.isRunning = true;
            this.gameLoop();

            console.log("ğŸ® ã‚²ãƒ¼ãƒ æº–å‚™å®Œäº†ï¼ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
          } catch (error) {
            console.error("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          }
        }

        gameLoop() {
          if (!this.gameState.isRunning) return;

          const currentTime = performance.now();
          const deltaTime = currentTime - this.lastFrameTime;
          this.lastFrameTime = currentTime;

          // FPSè¨ˆç®—
          this.frameCount++;
          if (currentTime - this.fpsUpdateTime >= 1000) {
            this.fps = this.frameCount;
            this.frameCount = 0;
            this.fpsUpdateTime = currentTime;
          }

          this.update(deltaTime);
          this.render();

          requestAnimationFrame(() => this.gameLoop());
        }

        update(deltaTime) {
          // å…¥åŠ›æ›´æ–°
          this.inputManager.update();
          const input = this.inputManager.getPlayerInput();

          // ã‚¸ãƒ£ãƒ³ãƒ—è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
          if (this.jumpIndicatorTimer > 0) {
            this.jumpIndicatorTimer -= deltaTime;
            if (this.jumpIndicatorTimer <= 0) {
              this.jumpIndicator.classList.add("hidden");
            }
          }

          // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç†
          switch (this.gameState.mode) {
            case "menu":
              this.updateMenu(input);
              break;
            case "playing":
              this.updateGameplay(deltaTime, input);
              break;
            case "paused":
              this.updatePaused(input);
              break;
          }
        }

        updateMenu(input) {
          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã®ã‚²ãƒ¼ãƒ é–‹å§‹
          if (input.jump || input.enter) {
            console.log("ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
            this.startGame();
          }
        }

        updateGameplay(deltaTime, input) {
          // ãƒãƒ¼ã‚ºãƒã‚§ãƒƒã‚¯
          if (input.pause) {
            this.pauseGame();
            return;
          }

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
          if (input.escape) {
            this.returnToMenu();
            return;
          }

          // ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›ã®è©³ç´°ãƒ­ã‚°
          if (input.jump) {
            console.log("ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›æ¤œå‡ºï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹:", {
              position: this.player.position,
              velocity: this.player.velocity,
              isOnGround: this.player.isOnGround,
              state: this.player.state,
            });

            // ã‚¸ãƒ£ãƒ³ãƒ—è¡¨ç¤º
            this.showJumpIndicator();
          }

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
          this.player.update(deltaTime, input);

          // ç‰©ç†æ›´æ–°
          this.updatePhysics(deltaTime);
        }

        updatePaused(input) {
          // ãƒãƒ¼ã‚ºè§£é™¤
          if (input.pause) {
            this.resumeGame();
          }

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
          if (input.escape) {
            this.returnToMenu();
          }
        }

        updatePhysics(deltaTime) {
          // é‡åŠ›é©ç”¨
          this.physicsEngine.applyGravity(this.player, deltaTime);

          // æ‘©æ“¦é©ç”¨
          this.physicsEngine.applyFriction(
            this.player,
            deltaTime,
            this.player.isOnGround
          );

          // ä½ç½®æ›´æ–°
          this.physicsEngine.updatePosition(this.player, deltaTime);

          // ç°¡å˜ãªåœ°é¢è¡çªï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãŒè¤‡é›‘ãªå ´åˆã®ä»£æ›¿ï¼‰
          const groundY = 550;
          if (this.player.position.y + this.player.size.height >= groundY) {
            this.player.position.y = groundY - this.player.size.height;
            this.player.velocity.y = 0;
            this.player.isOnGround = true;
          } else {
            this.player.isOnGround = false;
          }

          // ç”»é¢ç«¯åˆ¶é™
          if (this.player.position.x < 0) {
            this.player.position.x = 0;
            this.player.velocity.x = 0;
          } else if (
            this.player.position.x + this.player.size.width >
            this.canvas.width
          ) {
            this.player.position.x = this.canvas.width - this.player.size.width;
            this.player.velocity.x = 0;
          }
        }

        render() {
          // èƒŒæ™¯ã‚¯ãƒªã‚¢
          this.ctx.fillStyle = "#5C94FC";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          // åœ°é¢æç”»
          this.ctx.fillStyle = "#8B4513";
          this.ctx.fillRect(0, 550, this.canvas.width, 50);

          // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æç”»ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
          this.ctx.fillStyle = "#228B22";
          this.ctx.fillRect(200, 450, 150, 20);
          this.ctx.fillRect(400, 350, 150, 20);
          this.ctx.fillRect(600, 250, 150, 20);

          if (this.gameState.mode === "playing") {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»
            this.player.render(this.ctx);

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æç”»
            this.renderDebugInfo();
          }

          // FPSè¡¨ç¤º
          this.ctx.fillStyle = "white";
          this.ctx.font = "14px Arial";
          this.ctx.textAlign = "left";
          this.ctx.fillText(`FPS: ${this.fps}`, 10, 25);
          this.ctx.fillText(`Mode: ${this.gameState.mode}`, 10, 45);

          if (this.gameState.mode === "playing") {
            this.ctx.fillText(
              `Position: ${Math.round(this.player.position.x)}, ${Math.round(
                this.player.position.y
              )}`,
              10,
              65
            );
            this.ctx.fillText(
              `Velocity: ${Math.round(this.player.velocity.x)}, ${Math.round(
                this.player.velocity.y
              )}`,
              10,
              85
            );
            this.ctx.fillText(
              `Ground: ${this.player.isOnGround ? "Yes" : "No"}`,
              10,
              105
            );
            this.ctx.fillText(`State: ${this.player.state}`, 10, 125);
          }

          // ãƒãƒ¼ã‚ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
          if (this.gameState.mode === "paused") {
            this.ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            this.ctx.fillStyle = "white";
            this.ctx.font = "32px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(
              "PAUSED",
              this.canvas.width / 2,
              this.canvas.height / 2
            );
            this.ctx.font = "16px Arial";
            this.ctx.fillText(
              "Press P to resume, ESC for menu",
              this.canvas.width / 2,
              this.canvas.height / 2 + 40
            );
          }
        }

        renderDebugInfo() {
          // ã‚¸ãƒ£ãƒ³ãƒ—è»Œè·¡è¡¨ç¤º
          if (!this.player.isOnGround) {
            this.ctx.strokeStyle = "yellow";
            this.ctx.lineWidth = 2;
            this.ctx.beginPath();
            this.ctx.arc(
              this.player.position.x + this.player.size.width / 2,
              this.player.position.y + this.player.size.height / 2,
              25,
              0,
              Math.PI * 2
            );
            this.ctx.stroke();
          }
        }

        startGame() {
          this.gameState.mode = "playing";
          this.instructionsElement.classList.add("hidden");
          this.hudElement.classList.remove("hidden");

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
          this.player.setPosition(100, 400);
          this.player.velocity = { x: 0, y: 0 };
          this.player.isOnGround = true;
          this.player.state = "idle";

          console.log("ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æº–å‚™å®Œäº†");
        }

        pauseGame() {
          this.gameState.mode = "paused";
          console.log("â¸ï¸ ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚º");
        }

        resumeGame() {
          this.gameState.mode = "playing";
          console.log("â–¶ï¸ ã‚²ãƒ¼ãƒ å†é–‹");
        }

        returnToMenu() {
          this.gameState.mode = "menu";
          this.instructionsElement.classList.remove("hidden");
          this.hudElement.classList.add("hidden");
          this.jumpIndicator.classList.add("hidden");
          console.log("ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹");
        }

        showJumpIndicator() {
          this.jumpIndicator.classList.remove("hidden");
          this.jumpIndicatorTimer = 1000; // 1ç§’é–“è¡¨ç¤º
        }
      }

      // ã‚²ãƒ¼ãƒ é–‹å§‹
      window.addEventListener("load", () => {
        console.log("ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ä¸­...");

        const game = new FixedGameEngine();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
        window.game = game;

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰
        window.debugJump = () => {
          if (game.inputManager) {
            const jumpTest = game.inputManager.testAlternativeJumpKeys();
            console.log("ã‚¸ãƒ£ãƒ³ãƒ—ã‚­ãƒ¼ãƒ†ã‚¹ãƒˆçµæœ:", jumpTest);
            return jumpTest;
          }
        };

        window.forceJump = () => {
          if (game.player) {
            const result = game.player.jump();
            console.log("å¼·åˆ¶ã‚¸ãƒ£ãƒ³ãƒ—çµæœ:", result);
            return result;
          }
        };

        console.log("ğŸ® ã‚²ãƒ¼ãƒ æº–å‚™å®Œäº†ï¼");
        console.log("ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰: debugJump(), forceJump()");
      });

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      window.addEventListener("error", (event) => {
        console.error("âŒ JavaScript ã‚¨ãƒ©ãƒ¼:", event.error);
      });

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
      document.addEventListener("click", () => {
        const canvas = document.getElementById("game-canvas");
        if (canvas) {
          canvas.focus();
        }
      });
    </script>
  </body>
</html>
