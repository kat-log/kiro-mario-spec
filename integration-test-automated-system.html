<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Integration Test - Automated Test System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn.success {
        background: #28a745;
      }
      .btn.warning {
        background: #ffc107;
        color: #212529;
      }
      .btn.danger {
        background: #dc3545;
      }
      .results {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      canvas {
        border: 2px solid #333;
        display: block;
        margin: 20px auto;
        background: #87ceeb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🧪 Automated Test System Integration Test</h1>
        <p>
          Testing the complete space key jump functionality with automated tests
        </p>
      </div>

      <div class="test-section">
        <h3>🎮 Game Engine</h3>
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div>
          <button class="btn success" onclick="initializeGame()">
            Initialize Game
          </button>
          <button class="btn" onclick="startGame()">Start Game</button>
          <button class="btn warning" onclick="pauseGame()">Pause</button>
          <button class="btn danger" onclick="stopGame()">Stop</button>
        </div>
        <div id="gameStatus" class="status info">Game not initialized</div>
      </div>

      <div class="test-section">
        <h3>🧪 Automated Tests</h3>
        <div>
          <button class="btn" onclick="runSpaceKeySimulation()">
            Simulate Space Key
          </button>
          <button class="btn" onclick="runJumpTests()">Run Jump Tests</button>
          <button class="btn" onclick="runRegressionTests()">
            Run Regression Tests
          </button>
          <button class="btn success" onclick="runFullTestSuite()">
            Run Full Test Suite
          </button>
        </div>
        <div id="testStatus" class="status info">Tests ready to run</div>
      </div>

      <div class="test-section">
        <h3>📊 Test Results</h3>
        <div id="testResults" class="results">
          Waiting for test execution...
        </div>
      </div>
    </div>

    <!-- Game Engine Scripts -->
    <script src="js/physics-engine.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/player.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/item.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/main.js"></script>

    <!-- Enhanced Systems -->
    <script src="js/input-diagnostic-system.js"></script>
    <script src="js/focus-manager.js"></script>
    <script src="js/enhanced-input-manager.js"></script>
    <script src="js/compatibility-layer.js"></script>
    <script src="js/fallback-input-system.js"></script>

    <!-- Test Systems -->
    <script src="js/automated-test-system.js"></script>

    <script>
      let gameEngine = null;
      let automatedTestSystem = null;
      let testResults = [];

      // Initialize the complete system
      async function initializeGame() {
        try {
          updateStatus("gameStatus", "Initializing game engine...", "info");

          const canvas = document.getElementById("gameCanvas");
          const ctx = canvas.getContext("2d");

          // Initialize game engine
          gameEngine = new GameEngine(canvas, ctx);
          await gameEngine.initialize();

          // Initialize automated test system
          automatedTestSystem = new AutomatedTestSystem(gameEngine);

          updateStatus(
            "gameStatus",
            "Game engine initialized successfully!",
            "success"
          );
          updateStatus("testStatus", "Automated test system ready", "success");

          logResult("✅ System initialization completed successfully");
          logResult(`   - Game Engine: ${gameEngine ? "OK" : "FAILED"}`);
          logResult(
            `   - Input Manager: ${gameEngine?.inputManager ? "OK" : "FAILED"}`
          );
          logResult(`   - Player: ${gameEngine?.player ? "OK" : "FAILED"}`);
          logResult(
            `   - Automated Test System: ${
              automatedTestSystem ? "OK" : "FAILED"
            }`
          );
        } catch (error) {
          updateStatus(
            "gameStatus",
            `Initialization failed: ${error.message}`,
            "error"
          );
          logResult(`❌ Initialization failed: ${error.message}`);
        }
      }

      function startGame() {
        if (gameEngine) {
          gameEngine.startGame();
          updateStatus("gameStatus", "Game running", "success");
          logResult("🎮 Game started");
        } else {
          updateStatus("gameStatus", "Game not initialized", "error");
        }
      }

      function pauseGame() {
        if (gameEngine) {
          gameEngine.togglePause();
          logResult("⏸️ Game paused/resumed");
        }
      }

      function stopGame() {
        if (gameEngine) {
          gameEngine.stopGame();
          updateStatus("gameStatus", "Game stopped", "info");
          logResult("⏹️ Game stopped");
        }
      }

      // Test execution functions
      async function runSpaceKeySimulation() {
        if (!automatedTestSystem) {
          updateStatus("testStatus", "Test system not initialized", "error");
          return;
        }

        updateStatus("testStatus", "Running space key simulation...", "info");
        logResult("\n🧪 Starting space key simulation test...");

        try {
          const result = await automatedTestSystem.simulateSpaceKeyInput({
            repeat: 3,
            duration: 100,
            interval: 300,
          });

          if (result.success) {
            updateStatus(
              "testStatus",
              "Space key simulation completed",
              "success"
            );
            logResult("✅ Space key simulation successful");
            logResult(`   - Events simulated: ${result.events.length}`);
            logResult(
              `   - Success rate: ${
                result.events.filter((e) => e.success).length
              }/${result.events.length}`
            );
          } else {
            updateStatus("testStatus", "Space key simulation failed", "error");
            logResult("❌ Space key simulation failed");
            logResult(`   - Errors: ${result.errors.join(", ")}`);
          }
        } catch (error) {
          updateStatus(
            "testStatus",
            `Simulation error: ${error.message}`,
            "error"
          );
          logResult(`❌ Simulation error: ${error.message}`);
        }
      }

      async function runJumpTests() {
        if (!automatedTestSystem) {
          updateStatus("testStatus", "Test system not initialized", "error");
          return;
        }

        updateStatus(
          "testStatus",
          "Running jump verification tests...",
          "info"
        );
        logResult("\n🔍 Starting jump verification tests...");

        try {
          const results = await automatedTestSystem.runJumpVerificationTests();

          const successRate =
            (results.summary.passed / results.summary.total) * 100;

          if (results.summary.failed === 0 && results.summary.errors === 0) {
            updateStatus(
              "testStatus",
              `Jump tests passed (${successRate.toFixed(1)}%)`,
              "success"
            );
          } else {
            updateStatus(
              "testStatus",
              `Jump tests completed with issues`,
              "error"
            );
          }

          logResult(`✅ Jump verification tests completed`);
          logResult(`   - Total tests: ${results.summary.total}`);
          logResult(`   - Passed: ${results.summary.passed}`);
          logResult(`   - Failed: ${results.summary.failed}`);
          logResult(`   - Errors: ${results.summary.errors}`);
          logResult(`   - Success rate: ${successRate.toFixed(1)}%`);

          // Log individual test results
          results.tests.forEach((test) => {
            const status = test.success ? "✅" : "❌";
            logResult(`   ${status} ${test.name}: ${test.message}`);
          });

          testResults.push(results);
        } catch (error) {
          updateStatus(
            "testStatus",
            `Jump tests error: ${error.message}`,
            "error"
          );
          logResult(`❌ Jump tests error: ${error.message}`);
        }
      }

      async function runRegressionTests() {
        if (!automatedTestSystem) {
          updateStatus("testStatus", "Test system not initialized", "error");
          return;
        }

        updateStatus("testStatus", "Running regression tests...", "info");
        logResult("\n🔄 Starting regression test suite...");

        try {
          const results = await automatedTestSystem.buildRegressionTestSuite();

          const successRate = results.summary.successRate;

          if (results.summary.regressionDetected) {
            updateStatus("testStatus", "Regression detected!", "error");
            logResult("❌ Regression detected!");
            if (results.regressionDetails) {
              logResult(
                `   - Current success rate: ${results.regressionDetails.currentSuccessRate.toFixed(
                  1
                )}%`
              );
              logResult(
                `   - Baseline success rate: ${results.regressionDetails.baselineSuccessRate.toFixed(
                  1
                )}%`
              );
              logResult(
                `   - Degradation: ${results.regressionDetails.degradation.toFixed(
                  1
                )}%`
              );
            }
          } else {
            updateStatus(
              "testStatus",
              `Regression tests passed (${successRate.toFixed(1)}%)`,
              "success"
            );
            logResult("✅ No regression detected");
          }

          logResult(`📊 Regression test results:`);
          logResult(`   - Total tests: ${results.summary.totalTests}`);
          logResult(`   - Passed: ${results.summary.totalPassed}`);
          logResult(`   - Failed: ${results.summary.totalFailed}`);
          logResult(`   - Success rate: ${successRate.toFixed(1)}%`);

          // Log test suite results
          results.testSuites.forEach((suite) => {
            const suiteSuccessRate =
              (suite.summary.passed / suite.summary.total) * 100;
            logResult(
              `   📁 ${suite.name}: ${suiteSuccessRate.toFixed(1)}% (${
                suite.summary.passed
              }/${suite.summary.total})`
            );
          });

          testResults.push(results);
        } catch (error) {
          updateStatus(
            "testStatus",
            `Regression tests error: ${error.message}`,
            "error"
          );
          logResult(`❌ Regression tests error: ${error.message}`);
        }
      }

      async function runFullTestSuite() {
        if (!automatedTestSystem) {
          updateStatus("testStatus", "Test system not initialized", "error");
          return;
        }

        updateStatus("testStatus", "Running full test suite...", "info");
        logResult("\n🚀 Starting comprehensive automated test suite...");

        try {
          const startTime = performance.now();
          const results = await automatedTestSystem.runAllAutomatedTests();
          const duration = performance.now() - startTime;

          logResult(`🎉 Full test suite completed in ${duration.toFixed(0)}ms`);

          // Display jump verification results
          if (results.jumpVerificationTests) {
            const jumpResults = results.jumpVerificationTests;
            const jumpSuccessRate =
              (jumpResults.summary.passed / jumpResults.summary.total) * 100;
            logResult(`\n📋 Jump Verification Tests:`);
            logResult(`   - Success rate: ${jumpSuccessRate.toFixed(1)}%`);
            logResult(
              `   - Tests: ${jumpResults.summary.passed}/${jumpResults.summary.total} passed`
            );
          }

          // Display regression results
          if (results.regressionTests) {
            const regressionResults = results.regressionTests;
            logResult(`\n📋 Regression Tests:`);
            logResult(
              `   - Success rate: ${regressionResults.summary.successRate.toFixed(
                1
              )}%`
            );
            logResult(
              `   - Tests: ${regressionResults.summary.totalPassed}/${regressionResults.summary.totalTests} passed`
            );

            if (regressionResults.summary.regressionDetected) {
              logResult(`   - ⚠️ Regression detected!`);
              updateStatus(
                "testStatus",
                "Full test suite completed - Regression detected",
                "error"
              );
            } else {
              logResult(`   - ✅ No regression detected`);
              updateStatus(
                "testStatus",
                "Full test suite completed successfully",
                "success"
              );
            }
          }

          testResults.push(results);
        } catch (error) {
          updateStatus(
            "testStatus",
            `Full test suite error: ${error.message}`,
            "error"
          );
          logResult(`❌ Full test suite error: ${error.message}`);
        }
      }

      // Utility functions
      function updateStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `status ${type}`;
      }

      function logResult(message) {
        const resultsElement = document.getElementById("testResults");
        const timestamp = new Date().toLocaleTimeString();
        resultsElement.textContent += `[${timestamp}] ${message}\n`;
        resultsElement.scrollTop = resultsElement.scrollHeight;
      }

      // Initialize on page load
      window.addEventListener("load", () => {
        logResult("🎮 Integration test page loaded");
        logResult('📝 Click "Initialize Game" to start the test system');
      });

      // Handle manual space key presses for comparison
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          logResult(`⌨️ Manual space key detected (for comparison)`);
          event.preventDefault();
        }
      });
    </script>
  </body>
</html>
