<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ - Mario Style Platformer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #87ceeb 0%, #98fb98 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      #game-container {
        position: relative;
        background: #000;
        border: 3px solid #333;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      #game-canvas {
        display: block;
        background: #5c94fc;
        image-rendering: pixelated;
      }

      #instructions {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
        max-width: 300px;
      }

      #debug-info {
        position: absolute;
        top: 10px;
        right: 10px;
        color: white;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <canvas id="game-canvas" width="800" height="600" tabindex="0"></canvas>
      <div id="instructions">
        <h3>ğŸ® ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ</h3>
        <p><strong>æ“ä½œæ–¹æ³•:</strong></p>
        <p>â€¢ å·¦å³ç§»å‹•: â†â†’ ã¾ãŸã¯ A/D</p>
        <p>â€¢ ã‚¸ãƒ£ãƒ³ãƒ—: ã‚¹ãƒšãƒ¼ã‚¹ ã¾ãŸã¯ â†‘ ã¾ãŸã¯ W ã¾ãŸã¯ Enter</p>
        <p>â€¢ ã‚²ãƒ¼ãƒ é–‹å§‹: ã‚¹ãƒšãƒ¼ã‚¹ ã¾ãŸã¯ Enter</p>
        <p><strong>èµ¤ã„å››è§’ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ï¼</strong></p>
      </div>
      <div id="debug-info">
        <div>FPS: <span id="fps">0</span></div>
        <div>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®: <span id="position">0, 0</span></div>
        <div>é€Ÿåº¦: <span id="velocity">0, 0</span></div>
        <div>åœ°é¢æ¥è§¦: <span id="ground">false</span></div>
        <div>çŠ¶æ…‹: <span id="state">idle</span></div>
        <div>æœ€å¾Œã®å…¥åŠ›: <span id="last-input">ãªã—</span></div>
      </div>
    </div>

    <!-- å¿…è¦ãªJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/focus-manager.js"></script>
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/player.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/fallback-input-system.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/jump-diagnostic-system.js"></script>
    <script src="js/debug-display-system.js"></script>

    <script>
      // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆç”¨ã®ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³
      class SimpleJumpTest {
        constructor() {
          this.canvas = document.getElementById("game-canvas");
          this.ctx = this.canvas.getContext("2d");

          // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
          this.gameStarted = false;
          this.lastFrameTime = 0;
          this.fps = 0;
          this.frameCount = 0;
          this.fpsUpdateTime = 0;

          // å…¥åŠ›ç®¡ç†
          this.inputManager = new InputManager(this.canvas);

          // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³
          this.physicsEngine = new PhysicsEngine();

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
          this.player = new Player(100, 400);

          // ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆåœ°é¢ï¼‰
          this.stage = new Stage();

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°ç”¨ã®è¦ç´ 
          this.debugElements = {
            fps: document.getElementById("fps"),
            position: document.getElementById("position"),
            velocity: document.getElementById("velocity"),
            ground: document.getElementById("ground"),
            state: document.getElementById("state"),
            lastInput: document.getElementById("last-input"),
          };

          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¢ºä¿
          this.canvas.focus();

          console.log("ğŸ® ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼");
          console.log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸä½ç½®:", this.player.position);
          console.log("ã‚¸ãƒ£ãƒ³ãƒ—ã‚­ãƒ¼è¨­å®š:", this.inputManager.keyBindings.jump);
        }

        start() {
          this.gameLoop();
        }

        gameLoop() {
          const currentTime = performance.now();
          const deltaTime = currentTime - this.lastFrameTime;
          this.lastFrameTime = currentTime;

          // FPSè¨ˆç®—
          this.frameCount++;
          if (currentTime - this.fpsUpdateTime >= 1000) {
            this.fps = this.frameCount;
            this.frameCount = 0;
            this.fpsUpdateTime = currentTime;
          }

          this.update(deltaTime);
          this.render();
          this.updateDebugInfo();

          requestAnimationFrame(() => this.gameLoop());
        }

        update(deltaTime) {
          // å…¥åŠ›æ›´æ–°
          this.inputManager.update();
          const input = this.inputManager.getPlayerInput();

          // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒã‚§ãƒƒã‚¯
          if (!this.gameStarted && (input.jump || input.enter)) {
            this.gameStarted = true;
            console.log("ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
            this.debugElements.lastInput.textContent = "ã‚²ãƒ¼ãƒ é–‹å§‹";
          }

          if (!this.gameStarted) return;

          // å…¥åŠ›ãƒ­ã‚°
          if (input.jump) {
            console.log("ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›æ¤œå‡ºï¼");
            this.debugElements.lastInput.textContent = "ã‚¸ãƒ£ãƒ³ãƒ—";
          } else if (input.moveLeft) {
            this.debugElements.lastInput.textContent = "å·¦ç§»å‹•";
          } else if (input.moveRight) {
            this.debugElements.lastInput.textContent = "å³ç§»å‹•";
          }

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
          this.player.update(deltaTime, input);

          // ç‰©ç†æ›´æ–°
          this.updatePhysics(deltaTime);
        }

        updatePhysics(deltaTime) {
          // é‡åŠ›é©ç”¨
          this.physicsEngine.applyGravity(this.player, deltaTime);

          // æ‘©æ“¦é©ç”¨
          this.physicsEngine.applyFriction(
            this.player,
            deltaTime,
            this.player.isOnGround
          );

          // ä½ç½®æ›´æ–°
          this.physicsEngine.updatePosition(this.player, deltaTime);

          // åœ°é¢ã¨ã®è¡çªãƒã‚§ãƒƒã‚¯
          const groundY = 550; // åœ°é¢ã®Yåº§æ¨™
          if (this.player.position.y + this.player.size.height >= groundY) {
            this.player.position.y = groundY - this.player.size.height;
            this.player.velocity.y = 0;
            this.player.isOnGround = true;
          } else {
            this.player.isOnGround = false;
          }

          // ç”»é¢ç«¯ã§ã®åˆ¶é™
          if (this.player.position.x < 0) {
            this.player.position.x = 0;
            this.player.velocity.x = 0;
          } else if (
            this.player.position.x + this.player.size.width >
            this.canvas.width
          ) {
            this.player.position.x = this.canvas.width - this.player.size.width;
            this.player.velocity.x = 0;
          }
        }

        render() {
          // èƒŒæ™¯ã‚¯ãƒªã‚¢
          this.ctx.fillStyle = "#5C94FC";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          // åœ°é¢æç”»
          this.ctx.fillStyle = "#8B4513";
          this.ctx.fillRect(0, 550, this.canvas.width, 50);

          if (!this.gameStarted) {
            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
            this.ctx.fillStyle = "white";
            this.ctx.font = "32px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(
              "ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼",
              this.canvas.width / 2,
              this.canvas.height / 2
            );
            this.ctx.font = "16px Arial";
            this.ctx.fillText(
              "ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ",
              this.canvas.width / 2,
              this.canvas.height / 2 + 40
            );
          } else {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»
            this.player.render(this.ctx);

            // ã‚¸ãƒ£ãƒ³ãƒ—è»Œè·¡è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (!this.player.isOnGround) {
              this.ctx.strokeStyle = "yellow";
              this.ctx.lineWidth = 2;
              this.ctx.beginPath();
              this.ctx.arc(
                this.player.position.x + this.player.size.width / 2,
                this.player.position.y + this.player.size.height / 2,
                20,
                0,
                Math.PI * 2
              );
              this.ctx.stroke();
            }
          }
        }

        updateDebugInfo() {
          this.debugElements.fps.textContent = this.fps;
          this.debugElements.position.textContent = `${Math.round(
            this.player.position.x
          )}, ${Math.round(this.player.position.y)}`;
          this.debugElements.velocity.textContent = `${Math.round(
            this.player.velocity.x
          )}, ${Math.round(this.player.velocity.y)}`;
          this.debugElements.ground.textContent = this.player.isOnGround
            ? "ã¯ã„"
            : "ã„ã„ãˆ";
          this.debugElements.state.textContent = this.player.state;
        }
      }

      // ãƒ†ã‚¹ãƒˆé–‹å§‹
      window.addEventListener("load", () => {
        const jumpTest = new SimpleJumpTest();
        jumpTest.start();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
        window.jumpTest = jumpTest;

        console.log("ğŸ® ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼");
        console.log("ãƒ‡ãƒãƒƒã‚°ç”¨: window.jumpTest ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½");
      });
    </script>
  </body>
</html>
