<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task 3 Physics Optimization - Verification Runner</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .game-canvas {
        text-align: center;
        margin: 20px 0;
      }

      canvas {
        border: 2px solid #333;
        background-color: #87ceeb;
      }

      .controls {
        text-align: center;
        margin: 20px 0;
      }

      .btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn:hover {
        background-color: #0056b3;
      }

      .btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .results {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }

      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Task 3: Physics Update Order Optimization</h1>
        <p>
          Verification of optimized physics engine update order implementation
        </p>
      </div>

      <div class="test-section">
        <h3>Implementation Requirements</h3>
        <ul>
          <li>✅ GameEngine updatePhysics() method modified</li>
          <li>✅ Input processing state preserved before physics updates</li>
          <li>✅ Ground state continuity ensured across frames</li>
          <li>
            ✅ Collision detection after ground state update logic improved
          </li>
          <li>✅ Detailed logging added for each physics update stage</li>
        </ul>
      </div>

      <div class="game-canvas">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
      </div>

      <div class="controls">
        <button class="btn" onclick="startVerification()" id="startBtn">
          Start Verification
        </button>
        <button class="btn" onclick="runQuickTest()" id="quickBtn">
          Quick Test
        </button>
        <button class="btn" onclick="clearResults()" id="clearBtn">
          Clear Results
        </button>
        <button class="btn" onclick="showPhysicsLogs()" id="logsBtn">
          Show Physics Logs
        </button>
      </div>

      <div id="statusContainer"></div>
      <div class="results" id="resultsContainer"></div>
    </div>

    <!-- Game Engine Scripts -->
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/player.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/item.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/main.js"></script>
    <script src="verify-task3-physics-optimization.js"></script>

    <script>
      let gameEngine;
      let verificationSystem;
      let gameInitialized = false;

      function showStatus(message, type = "info") {
        const container = document.getElementById("statusContainer");
        const statusDiv = document.createElement("div");
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;
        container.appendChild(statusDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.parentNode.removeChild(statusDiv);
          }
        }, 5000);
      }

      function appendResults(text) {
        const container = document.getElementById("resultsContainer");
        container.textContent += text + "\n";
        container.scrollTop = container.scrollHeight;
      }

      function clearResults() {
        document.getElementById("resultsContainer").textContent = "";
        document.getElementById("statusContainer").innerHTML = "";
      }

      async function initializeGame() {
        if (gameInitialized) return true;

        try {
          showStatus("Initializing game engine...", "info");

          const canvas = document.getElementById("gameCanvas");
          gameEngine = new GameEngine(canvas);

          const initialized = await gameEngine.init();
          if (initialized) {
            gameEngine.start();
            gameEngine.startGame();
            gameInitialized = true;
            showStatus("Game engine initialized successfully", "success");
            return true;
          } else {
            showStatus("Failed to initialize game engine", "error");
            return false;
          }
        } catch (error) {
          showStatus(`Initialization error: ${error.message}`, "error");
          console.error("Game initialization error:", error);
          return false;
        }
      }

      async function startVerification() {
        const startBtn = document.getElementById("startBtn");
        startBtn.disabled = true;
        startBtn.textContent = "Running Verification...";

        try {
          if (!(await initializeGame())) {
            return;
          }

          showStatus("Starting comprehensive verification...", "info");
          clearResults();

          verificationSystem = new Task3PhysicsVerification();
          const results = await verificationSystem.runAllTests(gameEngine);

          appendResults("=".repeat(60));
          appendResults("TASK 3 PHYSICS OPTIMIZATION VERIFICATION RESULTS");
          appendResults("=".repeat(60));

          const report = verificationSystem.generateReport();
          appendResults(JSON.stringify(report, null, 2));

          if (results.overallSuccess) {
            showStatus(
              "✅ Task 3 verification completed successfully!",
              "success"
            );
          } else {
            showStatus(
              "❌ Task 3 verification found issues that need attention",
              "error"
            );
          }
        } catch (error) {
          showStatus(`Verification error: ${error.message}`, "error");
          appendResults(`Error during verification: ${error.message}`);
          console.error("Verification error:", error);
        } finally {
          startBtn.disabled = false;
          startBtn.textContent = "Start Verification";
        }
      }

      async function runQuickTest() {
        try {
          if (!(await initializeGame())) {
            return;
          }

          showStatus("Running quick physics test...", "info");

          // Quick test: trigger jump and monitor physics logs
          const initialLogs = console.log.length || 0;

          // Simulate jump input
          if (gameEngine.inputManager) {
            gameEngine.inputManager.simulateKeyPress("Space");
          }

          // Wait for physics updates
          await new Promise((resolve) => setTimeout(resolve, 200));

          showStatus(
            "Quick test completed - check console for physics logs",
            "success"
          );
        } catch (error) {
          showStatus(`Quick test error: ${error.message}`, "error");
        }
      }

      function showPhysicsLogs() {
        if (!verificationSystem) {
          showStatus("Run verification first to capture physics logs", "error");
          return;
        }

        clearResults();
        appendResults("CAPTURED PHYSICS LOGS:");
        appendResults("=".repeat(40));

        verificationSystem.physicsLogs.forEach((log, index) => {
          appendResults(
            `${index + 1}. [${new Date(log.timestamp).toLocaleTimeString()}] ${
              log.message
            }`
          );
          if (log.data) {
            appendResults(`   Data: ${JSON.stringify(log.data, null, 2)}`);
          }
          appendResults("");
        });
      }

      // Initialize when page loads
      window.addEventListener("load", () => {
        showStatus("Page loaded - ready for verification", "info");
      });

      // Add keyboard shortcuts
      document.addEventListener("keydown", (event) => {
        if (event.key === "F1") {
          event.preventDefault();
          startVerification();
        } else if (event.key === "F2") {
          event.preventDefault();
          runQuickTest();
        }
      });
    </script>
  </body>
</html>
