<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚·ãƒ³ãƒ—ãƒ«ã‚¸ãƒ£ãƒ³ãƒ—ä¿®æ­£ç‰ˆ</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #87ceeb 0%, #98fb98 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      #game-container {
        background: #000;
        border: 3px solid #333;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      #game-canvas {
        display: block;
        background: #5c94fc;
      }

      #controls {
        margin: 20px 0;
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #debug-panel {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        margin: 10px 0;
        max-width: 800px;
      }

      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background: #1976d2;
      }

      .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 3px;
        margin: 2px;
        font-weight: bold;
      }

      .status.good {
        background: #4caf50;
        color: white;
      }
      .status.bad {
        background: #f44336;
        color: white;
      }
      .status.warning {
        background: #ff9800;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¦˜ ã‚·ãƒ³ãƒ—ãƒ«ã‚¸ãƒ£ãƒ³ãƒ—ä¿®æ­£ç‰ˆ</h1>

    <div id="controls">
      <h3>ğŸ® æ“ä½œæ–¹æ³•</h3>
      <p><strong>ç§»å‹•:</strong> â†â†’ ã¾ãŸã¯ A/D</p>
      <p><strong>ã‚¸ãƒ£ãƒ³ãƒ—:</strong> ã‚¹ãƒšãƒ¼ã‚¹ ã¾ãŸã¯ â†‘ ã¾ãŸã¯ W ã¾ãŸã¯ Enter</p>
      <p><strong>ãƒ‡ãƒãƒƒã‚°:</strong> ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨</p>
    </div>

    <div id="game-container">
      <canvas id="game-canvas" width="800" height="600" tabindex="0"></canvas>
    </div>

    <div id="debug-panel">
      <div>
        FPS: <span id="fps">0</span> | ä½ç½®: <span id="position">0, 0</span> |
        é€Ÿåº¦: <span id="velocity">0, 0</span> | åœ°é¢:
        <span id="ground" class="status">-</span> | çŠ¶æ…‹:
        <span id="state">idle</span>
      </div>

      <div style="margin-top: 10px">
        <button onclick="testJump()">ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="forceJump()">ğŸ’ª å¼·åˆ¶ã‚¸ãƒ£ãƒ³ãƒ—</button>
        <button onclick="resetPlayer()">ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="debugInput()">ğŸ” å…¥åŠ›ãƒ‡ãƒãƒƒã‚°</button>
        <button onclick="toggleDebug()">ğŸ“Š è©³ç´°ãƒ‡ãƒãƒƒã‚°</button>
      </div>

      <div
        id="debug-log"
        style="
          margin-top: 10px;
          max-height: 100px;
          overflow-y: auto;
          background: #222;
          padding: 5px;
          border-radius: 3px;
        "
      ></div>
    </div>

    <script>
      // æœ€å°é™ã®å¿…è¦ãªã‚¯ãƒ©ã‚¹ã‚’ç›´æ¥å®šç¾©
      class SimpleInputManager {
        constructor(canvas) {
          this.canvas = canvas;
          this.keys = {};
          this.prevKeys = {};

          // ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
          this.jumpKeys = ["Space", "ArrowUp", "KeyW", "Enter"];
          this.leftKeys = ["ArrowLeft", "KeyA"];
          this.rightKeys = ["ArrowRight", "KeyD"];

          this.setupEventListeners();
          this.canvas.focus();

          console.log("âœ… SimpleInputManageråˆæœŸåŒ–å®Œäº†");
        }

        setupEventListeners() {
          document.addEventListener("keydown", (e) => {
            this.keys[e.code] = true;
            if (
              this.jumpKeys.includes(e.code) ||
              this.leftKeys.includes(e.code) ||
              this.rightKeys.includes(e.code)
            ) {
              e.preventDefault();
              debugLog(`ğŸ”½ ã‚­ãƒ¼æŠ¼ä¸‹: ${e.code}`);
            }
          });

          document.addEventListener("keyup", (e) => {
            this.keys[e.code] = false;
            if (
              this.jumpKeys.includes(e.code) ||
              this.leftKeys.includes(e.code) ||
              this.rightKeys.includes(e.code)
            ) {
              e.preventDefault();
              debugLog(`ğŸ”¼ ã‚­ãƒ¼é›¢ä¸Š: ${e.code}`);
            }
          });

          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
          this.canvas.addEventListener("click", () => {
            this.canvas.focus();
          });
        }

        update() {
          // å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ä¿å­˜
          this.prevKeys = { ...this.keys };
        }

        isKeyPressed(keyCode) {
          return this.keys[keyCode] && !this.prevKeys[keyCode];
        }

        isKeyHeld(keyCode) {
          return this.keys[keyCode];
        }

        getInput() {
          return {
            jump: this.jumpKeys.some((key) => this.isKeyPressed(key)),
            jumpHeld: this.jumpKeys.some((key) => this.isKeyHeld(key)),
            moveLeft: this.leftKeys.some((key) => this.isKeyHeld(key)),
            moveRight: this.rightKeys.some((key) => this.isKeyHeld(key)),
          };
        }
      }

      class SimplePlayer {
        constructor(x, y) {
          this.position = { x: x || 100, y: y || 400 };
          this.velocity = { x: 0, y: 0 };
          this.size = { width: 32, height: 32 };

          // ç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          this.moveSpeed = 200;
          this.jumpPower = 400;
          this.gravity = 980;
          this.friction = 0.8;

          // çŠ¶æ…‹
          this.isOnGround = false;
          this.state = "idle";
          this.facing = "right";

          console.log("âœ… SimplePlayeråˆæœŸåŒ–å®Œäº†");
        }

        update(deltaTime, input) {
          const dt = deltaTime / 1000; // ãƒŸãƒªç§’ã‚’ç§’ã«å¤‰æ›

          // ç§»å‹•å…¥åŠ›å‡¦ç†
          if (input.moveLeft) {
            this.velocity.x = -this.moveSpeed;
            this.facing = "left";
            if (this.isOnGround) this.state = "running";
          } else if (input.moveRight) {
            this.velocity.x = this.moveSpeed;
            this.facing = "right";
            if (this.isOnGround) this.state = "running";
          } else {
            this.velocity.x *= this.friction;
            if (this.isOnGround && Math.abs(this.velocity.x) < 10) {
              this.velocity.x = 0;
              this.state = "idle";
            }
          }

          // ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›å‡¦ç†
          if (input.jump && this.isOnGround) {
            this.jump();
          }

          // é‡åŠ›é©ç”¨
          if (!this.isOnGround) {
            this.velocity.y += this.gravity * dt;
            this.state = "jumping";
          }

          // ä½ç½®æ›´æ–°
          this.position.x += this.velocity.x * dt;
          this.position.y += this.velocity.y * dt;

          // åœ°é¢è¡çªãƒã‚§ãƒƒã‚¯
          const groundY = 550;
          if (this.position.y + this.size.height >= groundY) {
            this.position.y = groundY - this.size.height;
            this.velocity.y = 0;
            this.isOnGround = true;
          } else {
            this.isOnGround = false;
          }

          // ç”»é¢ç«¯åˆ¶é™
          if (this.position.x < 0) {
            this.position.x = 0;
            this.velocity.x = 0;
          } else if (this.position.x + this.size.width > 800) {
            this.position.x = 800 - this.size.width;
            this.velocity.x = 0;
          }
        }

        jump() {
          if (this.isOnGround) {
            this.velocity.y = -this.jumpPower;
            this.isOnGround = false;
            this.state = "jumping";
            debugLog("ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—å®Ÿè¡Œï¼");
            return true;
          }
          debugLog("âŒ ã‚¸ãƒ£ãƒ³ãƒ—å¤±æ•— - åœ°é¢ã«ã„ã¾ã›ã‚“");
          return false;
        }

        render(ctx) {
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æœ¬ä½“
          ctx.fillStyle = this.isOnGround ? "#FF0000" : "#FF6666";
          ctx.fillRect(
            this.position.x,
            this.position.y,
            this.size.width,
            this.size.height
          );

          // å‘ãè¡¨ç¤º
          ctx.fillStyle = "#FFFFFF";
          const centerX = this.position.x + this.size.width / 2;
          const centerY = this.position.y + this.size.height / 2;

          ctx.beginPath();
          if (this.facing === "right") {
            ctx.moveTo(centerX + 8, centerY);
            ctx.lineTo(centerX + 2, centerY - 4);
            ctx.lineTo(centerX + 2, centerY + 4);
          } else {
            ctx.moveTo(centerX - 8, centerY);
            ctx.lineTo(centerX - 2, centerY - 4);
            ctx.lineTo(centerX - 2, centerY + 4);
          }
          ctx.closePath();
          ctx.fill();

          // ã‚¸ãƒ£ãƒ³ãƒ—è»Œè·¡
          if (!this.isOnGround) {
            ctx.strokeStyle = "yellow";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, Math.PI * 2);
            ctx.stroke();
          }
        }

        reset() {
          this.position = { x: 100, y: 400 };
          this.velocity = { x: 0, y: 0 };
          this.isOnGround = true;
          this.state = "idle";
          debugLog("ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚»ãƒƒãƒˆ");
        }
      }

      // ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³
      class SimpleGame {
        constructor() {
          this.canvas = document.getElementById("game-canvas");
          this.ctx = this.canvas.getContext("2d");

          // UIè¦ç´ 
          this.debugElements = {
            fps: document.getElementById("fps"),
            position: document.getElementById("position"),
            velocity: document.getElementById("velocity"),
            ground: document.getElementById("ground"),
            state: document.getElementById("state"),
          };

          // ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          this.inputManager = new SimpleInputManager(this.canvas);
          this.player = new SimplePlayer(100, 400);

          // ã‚¿ã‚¤ãƒŸãƒ³ã‚°
          this.lastTime = 0;
          this.fps = 0;
          this.frameCount = 0;
          this.fpsTime = 0;

          // ãƒ‡ãƒãƒƒã‚°
          this.showDetailedDebug = false;

          console.log("âœ… SimpleGameåˆæœŸåŒ–å®Œäº†");
          this.start();
        }

        start() {
          this.gameLoop();
        }

        gameLoop() {
          const currentTime = performance.now();
          const deltaTime = currentTime - this.lastTime;
          this.lastTime = currentTime;

          // FPSè¨ˆç®—
          this.frameCount++;
          if (currentTime - this.fpsTime >= 1000) {
            this.fps = this.frameCount;
            this.frameCount = 0;
            this.fpsTime = currentTime;
          }

          this.update(deltaTime);
          this.render();
          this.updateUI();

          requestAnimationFrame(() => this.gameLoop());
        }

        update(deltaTime) {
          this.inputManager.update();
          const input = this.inputManager.getInput();

          // è©³ç´°ãƒ‡ãƒãƒƒã‚°
          if (this.showDetailedDebug && input.jump) {
            debugLog(
              `ğŸ” ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›è©³ç´°: ground=${this.player.isOnGround}, state=${
                this.player.state
              }, y=${this.player.position.y.toFixed(1)}`
            );
          }

          this.player.update(deltaTime, input);
        }

        render() {
          // èƒŒæ™¯
          this.ctx.fillStyle = "#5C94FC";
          this.ctx.fillRect(0, 0, 800, 600);

          // åœ°é¢
          this.ctx.fillStyle = "#8B4513";
          this.ctx.fillRect(0, 550, 800, 50);

          // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
          this.ctx.fillStyle = "#228B22";
          this.ctx.fillRect(200, 450, 150, 20);
          this.ctx.fillRect(400, 350, 150, 20);
          this.ctx.fillRect(600, 250, 150, 20);

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
          this.player.render(this.ctx);

          // æ“ä½œèª¬æ˜
          this.ctx.fillStyle = "white";
          this.ctx.font = "16px Arial";
          this.ctx.textAlign = "center";
          this.ctx.fillText("ã‚¹ãƒšãƒ¼ã‚¹/â†‘/W/Enterã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼", 400, 30);
        }

        updateUI() {
          this.debugElements.fps.textContent = this.fps;
          this.debugElements.position.textContent = `${Math.round(
            this.player.position.x
          )}, ${Math.round(this.player.position.y)}`;
          this.debugElements.velocity.textContent = `${Math.round(
            this.player.velocity.x
          )}, ${Math.round(this.player.velocity.y)}`;

          const groundElement = this.debugElements.ground;
          if (this.player.isOnGround) {
            groundElement.textContent = "ã¯ã„";
            groundElement.className = "status good";
          } else {
            groundElement.textContent = "ã„ã„ãˆ";
            groundElement.className = "status bad";
          }

          this.debugElements.state.textContent = this.player.state;
        }
      }

      // ãƒ‡ãƒãƒƒã‚°é–¢æ•°
      let game = null;
      let debugLogElement = null;

      function debugLog(message) {
        console.log(message);
        if (debugLogElement) {
          const timestamp = new Date().toLocaleTimeString();
          debugLogElement.innerHTML += `[${timestamp}] ${message}\n`;
          debugLogElement.scrollTop = debugLogElement.scrollHeight;
        }
      }

      function testJump() {
        if (game && game.player) {
          const result = game.player.jump();
          debugLog(`ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¸ãƒ£ãƒ³ãƒ—: ${result ? "æˆåŠŸ" : "å¤±æ•—"}`);
          return result;
        }
        debugLog("âŒ ã‚²ãƒ¼ãƒ ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function forceJump() {
        if (game && game.player) {
          // å¼·åˆ¶çš„ã«åœ°é¢ã«é…ç½®ã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—
          game.player.position.y = 518; // åœ°é¢ã®ä¸Š
          game.player.velocity.y = 0;
          game.player.isOnGround = true;
          const result = game.player.jump();
          debugLog(`ğŸ’ª å¼·åˆ¶ã‚¸ãƒ£ãƒ³ãƒ—: ${result ? "æˆåŠŸ" : "å¤±æ•—"}`);
          return result;
        }
        debugLog("âŒ ã‚²ãƒ¼ãƒ ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function resetPlayer() {
        if (game && game.player) {
          game.player.reset();
          return true;
        }
        debugLog("âŒ ã‚²ãƒ¼ãƒ ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return false;
      }

      function debugInput() {
        if (game && game.inputManager) {
          const input = game.inputManager.getInput();
          const keys = Object.keys(game.inputManager.keys).filter(
            (key) => game.inputManager.keys[key]
          );
          debugLog(`ğŸ” ç¾åœ¨ã®å…¥åŠ›: ${JSON.stringify(input)}`);
          debugLog(`ğŸ” æŠ¼ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼: ${keys.join(", ") || "ãªã—"}`);
          return { input, keys };
        }
        debugLog("âŒ å…¥åŠ›ç®¡ç†ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return null;
      }

      function toggleDebug() {
        if (game) {
          game.showDetailedDebug = !game.showDetailedDebug;
          debugLog(`ğŸ“Š è©³ç´°ãƒ‡ãƒãƒƒã‚°: ${game.showDetailedDebug ? "ON" : "OFF"}`);
          return game.showDetailedDebug;
        }
        return false;
      }

      // åˆæœŸåŒ–
      window.addEventListener("load", () => {
        debugLogElement = document.getElementById("debug-log");
        debugLog("ğŸš€ ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ä¸­...");

        try {
          game = new SimpleGame();
          debugLog("ğŸ® ã‚²ãƒ¼ãƒ æº–å‚™å®Œäº†ï¼");

          // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
          window.game = game;
          window.testJump = testJump;
          window.forceJump = forceJump;
          window.resetPlayer = resetPlayer;
          window.debugInput = debugInput;
          window.toggleDebug = toggleDebug;

          debugLog("ğŸ”§ ãƒ‡ãƒãƒƒã‚°é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ");
        } catch (error) {
          debugLog("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + error.message);
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        }
      });

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      window.addEventListener("error", (event) => {
        debugLog("âŒ ã‚¨ãƒ©ãƒ¼: " + event.error.message);
        console.error("ã‚¨ãƒ©ãƒ¼:", event.error);
      });
    </script>
  </body>
</html>
