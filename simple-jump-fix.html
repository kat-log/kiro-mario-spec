<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>シンプルジャンプ修正版</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #87ceeb 0%, #98fb98 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      #game-container {
        background: #000;
        border: 3px solid #333;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      #game-canvas {
        display: block;
        background: #5c94fc;
      }

      #controls {
        margin: 20px 0;
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #debug-panel {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        margin: 10px 0;
        max-width: 800px;
      }

      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background: #1976d2;
      }

      .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 3px;
        margin: 2px;
        font-weight: bold;
      }

      .status.good {
        background: #4caf50;
        color: white;
      }
      .status.bad {
        background: #f44336;
        color: white;
      }
      .status.warning {
        background: #ff9800;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>🦘 シンプルジャンプ修正版</h1>

    <div id="controls">
      <h3>🎮 操作方法</h3>
      <p><strong>移動:</strong> ←→ または A/D</p>
      <p><strong>ジャンプ:</strong> スペース または ↑ または W または Enter</p>
      <p><strong>デバッグ:</strong> 下のボタンを使用</p>
    </div>

    <div id="game-container">
      <canvas id="game-canvas" width="800" height="600" tabindex="0"></canvas>
    </div>

    <div id="debug-panel">
      <div>
        FPS: <span id="fps">0</span> | 位置: <span id="position">0, 0</span> |
        速度: <span id="velocity">0, 0</span> | 地面:
        <span id="ground" class="status">-</span> | 状態:
        <span id="state">idle</span>
      </div>

      <div style="margin-top: 10px">
        <button onclick="testJump()">🦘 ジャンプテスト</button>
        <button onclick="forceJump()">💪 強制ジャンプ</button>
        <button onclick="resetPlayer()">🔄 プレイヤーリセット</button>
        <button onclick="debugInput()">🔍 入力デバッグ</button>
        <button onclick="toggleDebug()">📊 詳細デバッグ</button>
      </div>

      <div
        id="debug-log"
        style="
          margin-top: 10px;
          max-height: 100px;
          overflow-y: auto;
          background: #222;
          padding: 5px;
          border-radius: 3px;
        "
      ></div>
    </div>

    <script>
      // 最小限の必要なクラスを直接定義
      class SimpleInputManager {
        constructor(canvas) {
          this.canvas = canvas;
          this.keys = {};
          this.prevKeys = {};

          // キーバインディング
          this.jumpKeys = ["Space", "ArrowUp", "KeyW", "Enter"];
          this.leftKeys = ["ArrowLeft", "KeyA"];
          this.rightKeys = ["ArrowRight", "KeyD"];

          this.setupEventListeners();
          this.canvas.focus();

          console.log("✅ SimpleInputManager初期化完了");
        }

        setupEventListeners() {
          document.addEventListener("keydown", (e) => {
            this.keys[e.code] = true;
            if (
              this.jumpKeys.includes(e.code) ||
              this.leftKeys.includes(e.code) ||
              this.rightKeys.includes(e.code)
            ) {
              e.preventDefault();
              debugLog(`🔽 キー押下: ${e.code}`);
            }
          });

          document.addEventListener("keyup", (e) => {
            this.keys[e.code] = false;
            if (
              this.jumpKeys.includes(e.code) ||
              this.leftKeys.includes(e.code) ||
              this.rightKeys.includes(e.code)
            ) {
              e.preventDefault();
              debugLog(`🔼 キー離上: ${e.code}`);
            }
          });

          // フォーカス管理
          this.canvas.addEventListener("click", () => {
            this.canvas.focus();
          });
        }

        update() {
          // 前フレームの状態を保存
          this.prevKeys = { ...this.keys };
        }

        isKeyPressed(keyCode) {
          return this.keys[keyCode] && !this.prevKeys[keyCode];
        }

        isKeyHeld(keyCode) {
          return this.keys[keyCode];
        }

        getInput() {
          return {
            jump: this.jumpKeys.some((key) => this.isKeyPressed(key)),
            jumpHeld: this.jumpKeys.some((key) => this.isKeyHeld(key)),
            moveLeft: this.leftKeys.some((key) => this.isKeyHeld(key)),
            moveRight: this.rightKeys.some((key) => this.isKeyHeld(key)),
          };
        }
      }

      class SimplePlayer {
        constructor(x, y) {
          this.position = { x: x || 100, y: y || 400 };
          this.velocity = { x: 0, y: 0 };
          this.size = { width: 32, height: 32 };

          // 物理パラメータ
          this.moveSpeed = 200;
          this.jumpPower = 400;
          this.gravity = 980;
          this.friction = 0.8;

          // 状態
          this.isOnGround = false;
          this.state = "idle";
          this.facing = "right";

          console.log("✅ SimplePlayer初期化完了");
        }

        update(deltaTime, input) {
          const dt = deltaTime / 1000; // ミリ秒を秒に変換

          // 移動入力処理
          if (input.moveLeft) {
            this.velocity.x = -this.moveSpeed;
            this.facing = "left";
            if (this.isOnGround) this.state = "running";
          } else if (input.moveRight) {
            this.velocity.x = this.moveSpeed;
            this.facing = "right";
            if (this.isOnGround) this.state = "running";
          } else {
            this.velocity.x *= this.friction;
            if (this.isOnGround && Math.abs(this.velocity.x) < 10) {
              this.velocity.x = 0;
              this.state = "idle";
            }
          }

          // ジャンプ入力処理
          if (input.jump && this.isOnGround) {
            this.jump();
          }

          // 重力適用
          if (!this.isOnGround) {
            this.velocity.y += this.gravity * dt;
            this.state = "jumping";
          }

          // 位置更新
          this.position.x += this.velocity.x * dt;
          this.position.y += this.velocity.y * dt;

          // 地面衝突チェック
          const groundY = 550;
          if (this.position.y + this.size.height >= groundY) {
            this.position.y = groundY - this.size.height;
            this.velocity.y = 0;
            this.isOnGround = true;
          } else {
            this.isOnGround = false;
          }

          // 画面端制限
          if (this.position.x < 0) {
            this.position.x = 0;
            this.velocity.x = 0;
          } else if (this.position.x + this.size.width > 800) {
            this.position.x = 800 - this.size.width;
            this.velocity.x = 0;
          }
        }

        jump() {
          if (this.isOnGround) {
            this.velocity.y = -this.jumpPower;
            this.isOnGround = false;
            this.state = "jumping";
            debugLog("🦘 ジャンプ実行！");
            return true;
          }
          debugLog("❌ ジャンプ失敗 - 地面にいません");
          return false;
        }

        render(ctx) {
          // プレイヤー本体
          ctx.fillStyle = this.isOnGround ? "#FF0000" : "#FF6666";
          ctx.fillRect(
            this.position.x,
            this.position.y,
            this.size.width,
            this.size.height
          );

          // 向き表示
          ctx.fillStyle = "#FFFFFF";
          const centerX = this.position.x + this.size.width / 2;
          const centerY = this.position.y + this.size.height / 2;

          ctx.beginPath();
          if (this.facing === "right") {
            ctx.moveTo(centerX + 8, centerY);
            ctx.lineTo(centerX + 2, centerY - 4);
            ctx.lineTo(centerX + 2, centerY + 4);
          } else {
            ctx.moveTo(centerX - 8, centerY);
            ctx.lineTo(centerX - 2, centerY - 4);
            ctx.lineTo(centerX - 2, centerY + 4);
          }
          ctx.closePath();
          ctx.fill();

          // ジャンプ軌跡
          if (!this.isOnGround) {
            ctx.strokeStyle = "yellow";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, Math.PI * 2);
            ctx.stroke();
          }
        }

        reset() {
          this.position = { x: 100, y: 400 };
          this.velocity = { x: 0, y: 0 };
          this.isOnGround = true;
          this.state = "idle";
          debugLog("🔄 プレイヤーリセット");
        }
      }

      // ゲームエンジン
      class SimpleGame {
        constructor() {
          this.canvas = document.getElementById("game-canvas");
          this.ctx = this.canvas.getContext("2d");

          // UI要素
          this.debugElements = {
            fps: document.getElementById("fps"),
            position: document.getElementById("position"),
            velocity: document.getElementById("velocity"),
            ground: document.getElementById("ground"),
            state: document.getElementById("state"),
          };

          // ゲームオブジェクト
          this.inputManager = new SimpleInputManager(this.canvas);
          this.player = new SimplePlayer(100, 400);

          // タイミング
          this.lastTime = 0;
          this.fps = 0;
          this.frameCount = 0;
          this.fpsTime = 0;

          // デバッグ
          this.showDetailedDebug = false;

          console.log("✅ SimpleGame初期化完了");
          this.start();
        }

        start() {
          this.gameLoop();
        }

        gameLoop() {
          const currentTime = performance.now();
          const deltaTime = currentTime - this.lastTime;
          this.lastTime = currentTime;

          // FPS計算
          this.frameCount++;
          if (currentTime - this.fpsTime >= 1000) {
            this.fps = this.frameCount;
            this.frameCount = 0;
            this.fpsTime = currentTime;
          }

          this.update(deltaTime);
          this.render();
          this.updateUI();

          requestAnimationFrame(() => this.gameLoop());
        }

        update(deltaTime) {
          this.inputManager.update();
          const input = this.inputManager.getInput();

          // 詳細デバッグ
          if (this.showDetailedDebug && input.jump) {
            debugLog(
              `🔍 ジャンプ入力詳細: ground=${this.player.isOnGround}, state=${
                this.player.state
              }, y=${this.player.position.y.toFixed(1)}`
            );
          }

          this.player.update(deltaTime, input);
        }

        render() {
          // 背景
          this.ctx.fillStyle = "#5C94FC";
          this.ctx.fillRect(0, 0, 800, 600);

          // 地面
          this.ctx.fillStyle = "#8B4513";
          this.ctx.fillRect(0, 550, 800, 50);

          // プラットフォーム
          this.ctx.fillStyle = "#228B22";
          this.ctx.fillRect(200, 450, 150, 20);
          this.ctx.fillRect(400, 350, 150, 20);
          this.ctx.fillRect(600, 250, 150, 20);

          // プレイヤー
          this.player.render(this.ctx);

          // 操作説明
          this.ctx.fillStyle = "white";
          this.ctx.font = "16px Arial";
          this.ctx.textAlign = "center";
          this.ctx.fillText("スペース/↑/W/Enterでジャンプ！", 400, 30);
        }

        updateUI() {
          this.debugElements.fps.textContent = this.fps;
          this.debugElements.position.textContent = `${Math.round(
            this.player.position.x
          )}, ${Math.round(this.player.position.y)}`;
          this.debugElements.velocity.textContent = `${Math.round(
            this.player.velocity.x
          )}, ${Math.round(this.player.velocity.y)}`;

          const groundElement = this.debugElements.ground;
          if (this.player.isOnGround) {
            groundElement.textContent = "はい";
            groundElement.className = "status good";
          } else {
            groundElement.textContent = "いいえ";
            groundElement.className = "status bad";
          }

          this.debugElements.state.textContent = this.player.state;
        }
      }

      // デバッグ関数
      let game = null;
      let debugLogElement = null;

      function debugLog(message) {
        console.log(message);
        if (debugLogElement) {
          const timestamp = new Date().toLocaleTimeString();
          debugLogElement.innerHTML += `[${timestamp}] ${message}\n`;
          debugLogElement.scrollTop = debugLogElement.scrollHeight;
        }
      }

      function testJump() {
        if (game && game.player) {
          const result = game.player.jump();
          debugLog(`🧪 テストジャンプ: ${result ? "成功" : "失敗"}`);
          return result;
        }
        debugLog("❌ ゲームまたはプレイヤーが見つかりません");
        return false;
      }

      function forceJump() {
        if (game && game.player) {
          // 強制的に地面に配置してジャンプ
          game.player.position.y = 518; // 地面の上
          game.player.velocity.y = 0;
          game.player.isOnGround = true;
          const result = game.player.jump();
          debugLog(`💪 強制ジャンプ: ${result ? "成功" : "失敗"}`);
          return result;
        }
        debugLog("❌ ゲームまたはプレイヤーが見つかりません");
        return false;
      }

      function resetPlayer() {
        if (game && game.player) {
          game.player.reset();
          return true;
        }
        debugLog("❌ ゲームまたはプレイヤーが見つかりません");
        return false;
      }

      function debugInput() {
        if (game && game.inputManager) {
          const input = game.inputManager.getInput();
          const keys = Object.keys(game.inputManager.keys).filter(
            (key) => game.inputManager.keys[key]
          );
          debugLog(`🔍 現在の入力: ${JSON.stringify(input)}`);
          debugLog(`🔍 押されているキー: ${keys.join(", ") || "なし"}`);
          return { input, keys };
        }
        debugLog("❌ 入力管理が見つかりません");
        return null;
      }

      function toggleDebug() {
        if (game) {
          game.showDetailedDebug = !game.showDetailedDebug;
          debugLog(`📊 詳細デバッグ: ${game.showDetailedDebug ? "ON" : "OFF"}`);
          return game.showDetailedDebug;
        }
        return false;
      }

      // 初期化
      window.addEventListener("load", () => {
        debugLogElement = document.getElementById("debug-log");
        debugLog("🚀 ゲーム初期化中...");

        try {
          game = new SimpleGame();
          debugLog("🎮 ゲーム準備完了！");

          // グローバル関数として公開
          window.game = game;
          window.testJump = testJump;
          window.forceJump = forceJump;
          window.resetPlayer = resetPlayer;
          window.debugInput = debugInput;
          window.toggleDebug = toggleDebug;

          debugLog("🔧 デバッグ関数が利用可能になりました");
        } catch (error) {
          debugLog("❌ 初期化エラー: " + error.message);
          console.error("初期化エラー:", error);
        }
      });

      // エラーハンドリング
      window.addEventListener("error", (event) => {
        debugLog("❌ エラー: " + event.error.message);
        console.error("エラー:", event.error);
      });
    </script>
  </body>
</html>
