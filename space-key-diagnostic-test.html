<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>スペースキージャンプ問題 - 詳細診断</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .diagnostic-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .panel h3 {
        margin-top: 0;
        color: #ffd700;
        border-bottom: 2px solid #ffd700;
        padding-bottom: 10px;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-ok {
        background: #4caf50;
      }
      .status-warning {
        background: #ff9800;
      }
      .status-error {
        background: #f44336;
      }
      .status-unknown {
        background: #9e9e9e;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .metric-label {
        font-weight: 500;
      }

      .metric-value {
        font-family: "Courier New", monospace;
        color: #00e676;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: linear-gradient(45deg, #2196f3, #1976d2);
      }

      .btn-warning {
        background: linear-gradient(45deg, #ff9800, #f57c00);
      }

      .btn-danger {
        background: linear-gradient(45deg, #f44336, #d32f2f);
      }

      .log-container {
        background: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .event-timeline {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
      }

      .event-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .event-time {
        font-family: "Courier New", monospace;
        font-size: 11px;
        color: #888;
        width: 80px;
        flex-shrink: 0;
      }

      .event-type {
        background: #333;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        margin-right: 10px;
        min-width: 80px;
        text-align: center;
      }

      .event-keydown {
        background: #4caf50;
      }
      .event-keyup {
        background: #2196f3;
      }
      .event-jump-attempt {
        background: #ff9800;
      }
      .event-jump-result {
        background: #9c27b0;
      }

      .game-canvas {
        border: 3px solid #ffd700;
        border-radius: 10px;
        display: block;
        margin: 20px auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .progress-bar {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid;
      }

      .alert-success {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
      }

      .alert-warning {
        background: rgba(255, 152, 0, 0.2);
        border-color: #ff9800;
      }

      .alert-error {
        background: rgba(244, 67, 54, 0.2);
        border-color: #f44336;
      }

      .diagnostic-summary {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .diagnostic-grid {
          grid-template-columns: 1fr;
        }

        .controls {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🔍 スペースキージャンプ問題 - 詳細診断システム</h1>
        <p>入力システムの各段階を詳細に分析し、問題の根本原因を特定します</p>
      </div>

      <div class="controls">
        <button class="btn" onclick="initializeGame()" id="init-btn">
          🎮 ゲーム初期化
        </button>
        <button
          class="btn btn-secondary"
          onclick="startDiagnostics()"
          id="start-diag-btn"
          disabled
        >
          🔍 診断開始
        </button>
        <button
          class="btn btn-warning"
          onclick="stopDiagnostics()"
          id="stop-diag-btn"
          disabled
        >
          ⏹️ 診断停止
        </button>
        <button
          class="btn btn-secondary"
          onclick="runFullTest()"
          id="test-btn"
          disabled
        >
          🧪 完全テスト実行
        </button>
        <button
          class="btn btn-secondary"
          onclick="runSelfDiagnostic()"
          id="self-diag-btn"
          disabled
        >
          🔧 自己診断実行
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
          🗑️ データクリア
        </button>
      </div>

      <canvas
        id="game-canvas"
        class="game-canvas"
        width="800"
        height="400"
        tabindex="0"
        style="display: none"
      >
        お使いのブラウザはHTML5 Canvasをサポートしていません。
      </canvas>

      <div class="diagnostic-grid">
        <!-- システム状態パネル -->
        <div class="panel">
          <h3>🖥️ システム状態</h3>
          <div id="system-status">
            <div class="metric-row">
              <span class="metric-label">ゲームエンジン:</span>
              <span class="metric-value" id="engine-status">未初期化</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">InputManager:</span>
              <span class="metric-value" id="input-status">未初期化</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Player:</span>
              <span class="metric-value" id="player-status">未初期化</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">診断システム:</span>
              <span class="metric-value" id="diagnostic-status">待機中</span>
            </div>
          </div>
        </div>

        <!-- フォーカス状態パネル -->
        <div class="panel">
          <h3>🎯 フォーカス状態</h3>
          <div id="focus-status">
            <div class="metric-row">
              <span class="metric-label">ドキュメントフォーカス:</span>
              <span class="metric-value" id="doc-focus">確認中...</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">アクティブ要素:</span>
              <span class="metric-value" id="active-element">確認中...</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Canvasフォーカス:</span>
              <span class="metric-value" id="canvas-focus">確認中...</span>
            </div>
          </div>
        </div>

        <!-- 入力統計パネル -->
        <div class="panel">
          <h3>📊 入力統計</h3>
          <div id="input-statistics">
            <div class="metric-row">
              <span class="metric-label">スペースキー押下:</span>
              <span class="metric-value" id="space-count">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">成功ジャンプ:</span>
              <span class="metric-value" id="jump-success">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">失敗ジャンプ:</span>
              <span class="metric-value" id="jump-failed">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">成功率:</span>
              <span class="metric-value" id="success-rate">N/A</span>
            </div>
          </div>
        </div>

        <!-- パフォーマンスパネル -->
        <div class="panel">
          <h3>⚡ パフォーマンス</h3>
          <div id="performance-metrics">
            <div class="metric-row">
              <span class="metric-label">平均レイテンシー:</span>
              <span class="metric-value" id="avg-latency">N/A</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">最大レイテンシー:</span>
              <span class="metric-value" id="max-latency">N/A</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">フォーカス問題:</span>
              <span class="metric-value" id="focus-issues">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 診断サマリー -->
      <div class="panel full-width">
        <h3>📋 診断サマリー</h3>
        <div id="diagnostic-summary" class="diagnostic-summary">
          診断を開始してください...
        </div>
      </div>

      <!-- イベントタイムライン -->
      <div class="panel full-width">
        <h3>⏱️ イベントタイムライン</h3>
        <div id="event-timeline" class="event-timeline">イベント待機中...</div>
      </div>

      <!-- デバッグログ -->
      <div class="panel full-width">
        <h3>📝 デバッグログ</h3>
        <div id="debug-log" class="log-container">システム準備中...</div>
      </div>
    </div>

    <!-- ゲームスクリプトの読み込み -->
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/player.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/input-diagnostic-system.js"></script>
    <script src="js/main.js"></script>

    <script>
      // グローバル変数
      let gameEngine = null;
      let diagnosticSystem = null;
      let logMessages = [];
      let isRecording = false;
      let updateInterval = null;

      // ログシステムの拡張
      const originalConsoleLog = console.log;
      const originalConsoleWarn = console.warn;
      const originalConsoleError = console.error;

      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        addLogMessage("INFO", args.join(" "));
      };

      console.warn = function (...args) {
        originalConsoleWarn.apply(console, args);
        addLogMessage("WARN", args.join(" "));
      };

      console.error = function (...args) {
        originalConsoleError.apply(console, args);
        addLogMessage("ERROR", args.join(" "));
      };

      function addLogMessage(level, message) {
        const timestamp = new Date().toLocaleTimeString();
        logMessages.push(`[${timestamp}] ${level}: ${message}`);

        // 最新100件のみ保持
        if (logMessages.length > 100) {
          logMessages.shift();
        }

        updateDebugLog();
      }

      function updateDebugLog() {
        const logDiv = document.getElementById("debug-log");
        logDiv.textContent = logMessages.join("\n");
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // ゲーム初期化
      async function initializeGame() {
        try {
          updateSystemStatus("engine-status", "初期化中...", "warning");
          console.log("=== ゲームエンジン初期化開始 ===");

          const canvas = document.getElementById("game-canvas");
          canvas.style.display = "block";

          gameEngine = new GameEngine(canvas);
          const success = await gameEngine.init();

          if (success) {
            updateSystemStatus("engine-status", "正常", "success");
            updateSystemStatus("input-status", "正常", "success");
            updateSystemStatus("player-status", "正常", "success");

            // 診断システムを初期化
            diagnosticSystem = new InputDiagnosticSystem(
              gameEngine.inputManager,
              gameEngine.player
            );

            updateSystemStatus("diagnostic-status", "準備完了", "success");

            // ボタンを有効化
            document.getElementById("start-diag-btn").disabled = false;
            document.getElementById("test-btn").disabled = false;
            document.getElementById("self-diag-btn").disabled = false;

            // ゲームを開始
            gameEngine.start();
            gameEngine.startGame();

            // フォーカスを設定
            canvas.focus();

            // リアルタイム更新を開始
            startRealTimeUpdates();

            console.log("=== ゲームエンジン初期化完了 ===");
            showAlert(
              "ゲームエンジンが正常に初期化されました。スペースキーでジャンプをテストできます。",
              "success"
            );
          } else {
            throw new Error("ゲームエンジンの初期化に失敗しました");
          }
        } catch (error) {
          console.error("初期化エラー:", error);
          updateSystemStatus("engine-status", "エラー", "error");
          showAlert(`初期化エラー: ${error.message}`, "error");
        }
      }

      // 診断開始
      function startDiagnostics() {
        if (!diagnosticSystem) {
          showAlert("診断システムが初期化されていません", "error");
          return;
        }

        diagnosticSystem.startDiagnostics();
        isRecording = true;

        updateSystemStatus("diagnostic-status", "記録中", "warning");
        document.getElementById("start-diag-btn").disabled = true;
        document.getElementById("stop-diag-btn").disabled = false;

        console.log("🔍 診断記録を開始しました");
        showAlert(
          "診断記録を開始しました。スペースキーでジャンプをテストしてください。",
          "success"
        );
      }

      // 診断停止
      function stopDiagnostics() {
        if (!diagnosticSystem || !isRecording) {
          return;
        }

        const report = diagnosticSystem.stopDiagnostics();
        isRecording = false;

        updateSystemStatus("diagnostic-status", "分析完了", "success");
        document.getElementById("start-diag-btn").disabled = false;
        document.getElementById("stop-diag-btn").disabled = true;

        // レポートを表示
        displayDiagnosticReport(report);

        console.log("🔍 診断記録を停止しました");
        console.log("📊 診断レポート:", report);
        showAlert("診断が完了しました。結果を確認してください。", "success");
      }

      // 完全テスト実行
      async function runFullTest() {
        if (!diagnosticSystem) {
          showAlert("診断システムが初期化されていません", "error");
          return;
        }

        console.log("🧪 完全テストを開始します");
        showAlert("完全テストを実行中...", "warning");

        // 1. 入力チェーン検証
        const chainValidation = diagnosticSystem.validateInputChain();
        console.log("🔗 入力チェーン検証:", chainValidation);

        // 2. ジャンプシーケンステスト
        const jumpTest = diagnosticSystem.testJumpSequence();
        console.log("🦘 ジャンプシーケンステスト:", jumpTest);

        // 3. シミュレーションテスト
        diagnosticSystem.startDiagnostics();

        for (let i = 0; i < 5; i++) {
          await new Promise((resolve) => setTimeout(resolve, 500));
          const simResult = diagnosticSystem.simulateSpaceKeyPress();
          console.log(`🎯 シミュレーション ${i + 1}:`, simResult);
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));
        const finalReport = diagnosticSystem.stopDiagnostics();

        displayDiagnosticReport(finalReport);
        showAlert(
          "完全テストが完了しました。詳細な結果を確認してください。",
          "success"
        );
      }

      // 自己診断実行
      function runSelfDiagnostic() {
        if (!diagnosticSystem) {
          showAlert("診断システムが初期化されていません", "error");
          return;
        }

        console.log("🔧 自己診断を実行します");
        showAlert("自己診断を実行中...", "warning");

        try {
          const selfDiagResult = diagnosticSystem.runSelfDiagnostic();
          console.log("🔧 自己診断結果:", selfDiagResult);

          // 結果を表示
          const summaryDiv = document.getElementById("diagnostic-summary");
          let html = `
            <div class="alert alert-${
              selfDiagResult.systemStatus === "healthy"
                ? "success"
                : selfDiagResult.systemStatus === "critical"
                ? "error"
                : "warning"
            }">
              <h4>🔧 自己診断結果</h4>
              <p><strong>システム状態:</strong> ${
                selfDiagResult.systemStatus
              }</p>
              <p><strong>実行時刻:</strong> ${new Date(
                selfDiagResult.timestamp
              ).toLocaleString()}</p>
            </div>
          `;

          // チェック結果を表示
          html += "<h4>📋 チェック結果</h4>";
          selfDiagResult.checks.forEach((check) => {
            const statusClass =
              check.status === "passed"
                ? "success"
                : check.status === "failed"
                ? "error"
                : "warning";
            html += `
              <div class="alert alert-${statusClass}">
                <strong>${check.name}:</strong> ${check.message}
              </div>
            `;
          });

          // 問題があれば表示
          if (selfDiagResult.issues.length > 0) {
            html += "<h4>🚨 検出された問題</h4>";
            selfDiagResult.issues.forEach((issue) => {
              html += `
                <div class="alert alert-error">
                  ${issue}
                </div>
              `;
            });
          }

          // 推奨事項があれば表示
          if (selfDiagResult.recommendations.length > 0) {
            html += "<h4>💡 推奨事項</h4>";
            selfDiagResult.recommendations.forEach((rec) => {
              html += `
                <div class="alert alert-success">
                  ${rec}
                </div>
              `;
            });
          }

          summaryDiv.innerHTML = html;
          showAlert("自己診断が完了しました", "success");
        } catch (error) {
          console.error("自己診断エラー:", error);
          showAlert(
            "自己診断でエラーが発生しました: " + error.message,
            "error"
          );
        }
      }

      // データクリア
      function clearAllData() {
        if (diagnosticSystem) {
          diagnosticSystem.reset();
        }

        logMessages = [];
        updateDebugLog();

        // 統計をリセット
        document.getElementById("space-count").textContent = "0";
        document.getElementById("jump-success").textContent = "0";
        document.getElementById("jump-failed").textContent = "0";
        document.getElementById("success-rate").textContent = "N/A";
        document.getElementById("avg-latency").textContent = "N/A";
        document.getElementById("max-latency").textContent = "N/A";
        document.getElementById("focus-issues").textContent = "0";

        // タイムラインをクリア
        document.getElementById("event-timeline").innerHTML =
          "イベント待機中...";
        document.getElementById("diagnostic-summary").innerHTML =
          "診断を開始してください...";

        console.log("🗑️ 全データをクリアしました");
        showAlert("全データがクリアされました", "success");
      }

      // システム状態更新
      function updateSystemStatus(elementId, status, type) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = status;
          element.className = `metric-value status-${type}`;
        }
      }

      // リアルタイム更新
      function startRealTimeUpdates() {
        if (updateInterval) {
          clearInterval(updateInterval);
        }

        updateInterval = setInterval(() => {
          updateFocusStatus();
          updateInputStatistics();
          updateEventTimeline();
          updateEnhancedMetrics(); // 新しい拡張メトリクス
        }, 100);
      }

      // 拡張メトリクスの更新
      function updateEnhancedMetrics() {
        if (!diagnosticSystem) return;

        try {
          // ダッシュボードデータを取得
          const dashboardData = diagnosticSystem.getDashboardData();

          // システムヘルス状態を更新
          if (dashboardData.status && dashboardData.status.systemHealth) {
            const healthStatus = dashboardData.status.systemHealth.overall;
            const healthElement = document.createElement("div");
            healthElement.className = `metric-row`;
            healthElement.innerHTML = `
              <span class="metric-label">システムヘルス:</span>
              <span class="metric-value status-${
                healthStatus === "good" ? "ok" : "warning"
              }">${healthStatus}</span>
            `;

            // 既存のシステム状態パネルに追加（重複を避けるため一度だけ）
            const systemPanel = document.getElementById("system-status");
            if (systemPanel && !systemPanel.querySelector(".system-health")) {
              healthElement.classList.add("system-health");
              systemPanel.appendChild(healthElement);
            }
          }

          // リアルタイムアラートを表示
          if (dashboardData.alerts && dashboardData.alerts.length > 0) {
            displayRealTimeAlerts(dashboardData.alerts);
          }

          // ライブメトリクスを更新
          if (dashboardData.metrics && dashboardData.metrics.liveMetrics) {
            updateLiveMetrics(dashboardData.metrics.liveMetrics);
          }
        } catch (error) {
          console.warn("Enhanced metrics update failed:", error);
        }
      }

      // リアルタイムアラートを表示
      function displayRealTimeAlerts(alerts) {
        const summaryDiv = document.getElementById("diagnostic-summary");
        if (!summaryDiv) return;

        const alertsHtml = alerts
          .slice(0, 3)
          .map(
            (alert) => `
          <div class="alert alert-${
            alert.severity === "high" ? "error" : "warning"
          }">
            <strong>🚨 ${alert.type}:</strong> ${alert.message}<br>
            <em>推奨アクション:</em> ${alert.action}
          </div>
        `
          )
          .join("");

        if (alertsHtml) {
          summaryDiv.innerHTML =
            `<h4>🚨 リアルタイムアラート</h4>${alertsHtml}` +
            summaryDiv.innerHTML;
        }
      }

      // ライブメトリクスを更新
      function updateLiveMetrics(liveMetrics) {
        // イベント/秒の表示を追加
        const performancePanel = document.getElementById("performance-metrics");
        if (performancePanel && liveMetrics.eventsPerSecond) {
          let eventsPerSecElement =
            performancePanel.querySelector(".events-per-sec");
          if (!eventsPerSecElement) {
            eventsPerSecElement = document.createElement("div");
            eventsPerSecElement.className = "metric-row events-per-sec";
            performancePanel.appendChild(eventsPerSecElement);
          }
          eventsPerSecElement.innerHTML = `
            <span class="metric-label">イベント/秒:</span>
            <span class="metric-value">${liveMetrics.eventsPerSecond}</span>
          `;
        }

        // 入力応答性の表示
        if (performancePanel && liveMetrics.inputResponsiveness) {
          let responsivenessElement = performancePanel.querySelector(
            ".input-responsiveness"
          );
          if (!responsivenessElement) {
            responsivenessElement = document.createElement("div");
            responsivenessElement.className = "metric-row input-responsiveness";
            performancePanel.appendChild(responsivenessElement);
          }
          responsivenessElement.innerHTML = `
            <span class="metric-label">入力応答性:</span>
            <span class="metric-value status-${
              liveMetrics.inputResponsiveness.status === "excellent"
                ? "ok"
                : "warning"
            }">
              ${liveMetrics.inputResponsiveness.status} (${
            liveMetrics.inputResponsiveness.score
          }%)
            </span>
          `;
        }
      }

      // フォーカス状態更新
      function updateFocusStatus() {
        const hasFocus = document.hasFocus();
        const activeElement = document.activeElement;
        const canvas = document.getElementById("game-canvas");
        const canvasFocused = activeElement === canvas;

        document.getElementById("doc-focus").textContent = hasFocus
          ? "✅ あり"
          : "❌ なし";
        document.getElementById("active-element").textContent =
          activeElement?.tagName || "なし";
        document.getElementById("canvas-focus").textContent = canvasFocused
          ? "✅ あり"
          : "❌ なし";
      }

      // 入力統計更新
      function updateInputStatistics() {
        if (!diagnosticSystem || !isRecording) return;

        const realTimeData = diagnosticSystem.getRealTimeDiagnostics();
        if (realTimeData.recording) {
          const stats = realTimeData.statistics;

          document.getElementById("space-count").textContent =
            stats.totalSpaceKeyEvents;
          document.getElementById("jump-success").textContent =
            stats.successfulJumps;
          document.getElementById("jump-failed").textContent =
            stats.failedJumps;

          const successRate =
            stats.totalSpaceKeyEvents > 0
              ? (
                  (stats.successfulJumps / stats.totalSpaceKeyEvents) *
                  100
                ).toFixed(1) + "%"
              : "N/A";
          document.getElementById("success-rate").textContent = successRate;

          document.getElementById("focus-issues").textContent =
            stats.focusIssues;
        }
      }

      // イベントタイムライン更新
      function updateEventTimeline() {
        if (!diagnosticSystem || !isRecording) return;

        const realTimeData = diagnosticSystem.getRealTimeDiagnostics();
        if (realTimeData.recording && realTimeData.recentEvents.length > 0) {
          const timeline = document.getElementById("event-timeline");
          const events = realTimeData.recentEvents.slice(-10); // 最新10件

          timeline.innerHTML = events
            .map((event) => {
              const time = new Date(event.timestamp).toLocaleTimeString();
              const typeClass = `event-${event.type.replace("-", "-")}`;

              return `
                        <div class="event-item">
                            <div class="event-time">${time}</div>
                            <div class="event-type ${typeClass}">${
                event.type
              }</div>
                            <div class="event-details">${JSON.stringify(
                              event.data,
                              null,
                              2
                            )}</div>
                        </div>
                    `;
            })
            .join("");
        }
      }

      // 診断レポート表示
      function displayDiagnosticReport(report) {
        const summaryDiv = document.getElementById("diagnostic-summary");

        let html = `
                <div class="alert alert-${
                  report.issues.length === 0 ? "success" : "warning"
                }">
                    <h4>📊 診断結果サマリー</h4>
                    <p><strong>期間:</strong> ${(
                      report.duration / 1000
                    ).toFixed(1)}秒</p>
                    <p><strong>総イベント数:</strong> ${
                      report.summary.totalEvents
                    }</p>
                    <p><strong>スペースキー押下:</strong> ${
                      report.summary.spaceKeyEvents
                    }</p>
                    <p><strong>成功ジャンプ:</strong> ${
                      report.summary.successfulJumps
                    }</p>
                    <p><strong>成功率:</strong> ${
                      report.summary.successRate
                    }</p>
                    <p><strong>平均レイテンシー:</strong> ${report.summary.averageLatency.toFixed(
                      1
                    )}ms</p>
                </div>
            `;

        if (report.issues.length > 0) {
          html += "<h4>🚨 検出された問題</h4>";
          report.issues.forEach((issue) => {
            html += `
                        <div class="alert alert-${
                          issue.severity === "high" ? "error" : "warning"
                        }">
                            <strong>${issue.type}:</strong> ${
              issue.description
            }<br>
                            <em>影響:</em> ${issue.impact}
                        </div>
                    `;
          });
        }

        if (report.recommendations.length > 0) {
          html += "<h4>💡 推奨事項</h4>";
          report.recommendations.forEach((rec) => {
            html += `
                        <div class="alert alert-success">
                            <strong>優先度 ${rec.priority}:</strong> ${rec.action}<br>
                            <em>詳細:</em> ${rec.details}
                        </div>
                    `;
          });
        }

        summaryDiv.innerHTML = html;

        // パフォーマンスメトリクスを更新
        if (report.performance.totalLatency.average) {
          document.getElementById("avg-latency").textContent =
            report.performance.totalLatency.average.toFixed(1) + "ms";
          document.getElementById("max-latency").textContent =
            report.performance.totalLatency.max.toFixed(1) + "ms";
        }
      }

      // アラート表示
      function showAlert(message, type) {
        // 既存のアラートを削除
        const existingAlert = document.querySelector(".temp-alert");
        if (existingAlert) {
          existingAlert.remove();
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} temp-alert`;
        alert.innerHTML = message;
        alert.style.position = "fixed";
        alert.style.top = "20px";
        alert.style.right = "20px";
        alert.style.zIndex = "1000";
        alert.style.maxWidth = "400px";

        document.body.appendChild(alert);

        // 5秒後に自動削除
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 5000);
      }

      // キーボードイベントリスナー（デバッグ用）
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          console.log("🔍 Raw Space keydown detected");
          event.preventDefault();
        }
      });

      document.addEventListener("keyup", (event) => {
        if (event.code === "Space") {
          console.log("🔍 Raw Space keyup detected");
        }
      });

      // Canvas フォーカス管理
      document.addEventListener("click", (event) => {
        const canvas = document.getElementById("game-canvas");
        if (event.target === canvas) {
          canvas.focus();
          console.log("Canvas focused by click");
        }
      });

      // ページ読み込み完了時
      window.addEventListener("load", () => {
        console.log("🚀 診断システム準備完了");
        addLogMessage("INFO", "診断システムが準備完了しました");
      });

      // ページ離脱時のクリーンアップ
      window.addEventListener("beforeunload", () => {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      });
    </script>
  </body>
</html>
