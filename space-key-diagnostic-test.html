<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—å•é¡Œ - è©³ç´°è¨ºæ–­</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .diagnostic-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .panel h3 {
        margin-top: 0;
        color: #ffd700;
        border-bottom: 2px solid #ffd700;
        padding-bottom: 10px;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-ok {
        background: #4caf50;
      }
      .status-warning {
        background: #ff9800;
      }
      .status-error {
        background: #f44336;
      }
      .status-unknown {
        background: #9e9e9e;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .metric-label {
        font-weight: 500;
      }

      .metric-value {
        font-family: "Courier New", monospace;
        color: #00e676;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: linear-gradient(45deg, #2196f3, #1976d2);
      }

      .btn-warning {
        background: linear-gradient(45deg, #ff9800, #f57c00);
      }

      .btn-danger {
        background: linear-gradient(45deg, #f44336, #d32f2f);
      }

      .log-container {
        background: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .event-timeline {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
      }

      .event-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .event-time {
        font-family: "Courier New", monospace;
        font-size: 11px;
        color: #888;
        width: 80px;
        flex-shrink: 0;
      }

      .event-type {
        background: #333;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        margin-right: 10px;
        min-width: 80px;
        text-align: center;
      }

      .event-keydown {
        background: #4caf50;
      }
      .event-keyup {
        background: #2196f3;
      }
      .event-jump-attempt {
        background: #ff9800;
      }
      .event-jump-result {
        background: #9c27b0;
      }

      .game-canvas {
        border: 3px solid #ffd700;
        border-radius: 10px;
        display: block;
        margin: 20px auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .progress-bar {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid;
      }

      .alert-success {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
      }

      .alert-warning {
        background: rgba(255, 152, 0, 0.2);
        border-color: #ff9800;
      }

      .alert-error {
        background: rgba(244, 67, 54, 0.2);
        border-color: #f44336;
      }

      .diagnostic-summary {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
      }

      @media (max-width: 768px) {
        .diagnostic-grid {
          grid-template-columns: 1fr;
        }

        .controls {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ” ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—å•é¡Œ - è©³ç´°è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ã®å„æ®µéšã‚’è©³ç´°ã«åˆ†æã—ã€å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¾ã™</p>
      </div>

      <div class="controls">
        <button class="btn" onclick="initializeGame()" id="init-btn">
          ğŸ® ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        </button>
        <button
          class="btn btn-secondary"
          onclick="startDiagnostics()"
          id="start-diag-btn"
          disabled
        >
          ğŸ” è¨ºæ–­é–‹å§‹
        </button>
        <button
          class="btn btn-warning"
          onclick="stopDiagnostics()"
          id="stop-diag-btn"
          disabled
        >
          â¹ï¸ è¨ºæ–­åœæ­¢
        </button>
        <button
          class="btn btn-secondary"
          onclick="runFullTest()"
          id="test-btn"
          disabled
        >
          ğŸ§ª å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
        <button
          class="btn btn-secondary"
          onclick="runSelfDiagnostic()"
          id="self-diag-btn"
          disabled
        >
          ğŸ”§ è‡ªå·±è¨ºæ–­å®Ÿè¡Œ
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
          ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        </button>
      </div>

      <canvas
        id="game-canvas"
        class="game-canvas"
        width="800"
        height="400"
        tabindex="0"
        style="display: none"
      >
        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯HTML5 Canvasã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
      </canvas>

      <div class="diagnostic-grid">
        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒ‘ãƒãƒ« -->
        <div class="panel">
          <h3>ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
          <div id="system-status">
            <div class="metric-row">
              <span class="metric-label">ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³:</span>
              <span class="metric-value" id="engine-status">æœªåˆæœŸåŒ–</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">InputManager:</span>
              <span class="metric-value" id="input-status">æœªåˆæœŸåŒ–</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Player:</span>
              <span class="metric-value" id="player-status">æœªåˆæœŸåŒ–</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ :</span>
              <span class="metric-value" id="diagnostic-status">å¾…æ©Ÿä¸­</span>
            </div>
          </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ãƒ‘ãƒãƒ« -->
        <div class="panel">
          <h3>ğŸ¯ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹</h3>
          <div id="focus-status">
            <div class="metric-row">
              <span class="metric-label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹:</span>
              <span class="metric-value" id="doc-focus">ç¢ºèªä¸­...</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ :</span>
              <span class="metric-value" id="active-element">ç¢ºèªä¸­...</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Canvasãƒ•ã‚©ãƒ¼ã‚«ã‚¹:</span>
              <span class="metric-value" id="canvas-focus">ç¢ºèªä¸­...</span>
            </div>
          </div>
        </div>

        <!-- å…¥åŠ›çµ±è¨ˆãƒ‘ãƒãƒ« -->
        <div class="panel">
          <h3>ğŸ“Š å…¥åŠ›çµ±è¨ˆ</h3>
          <div id="input-statistics">
            <div class="metric-row">
              <span class="metric-label">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼æŠ¼ä¸‹:</span>
              <span class="metric-value" id="space-count">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">æˆåŠŸã‚¸ãƒ£ãƒ³ãƒ—:</span>
              <span class="metric-value" id="jump-success">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">å¤±æ•—ã‚¸ãƒ£ãƒ³ãƒ—:</span>
              <span class="metric-value" id="jump-failed">0</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">æˆåŠŸç‡:</span>
              <span class="metric-value" id="success-rate">N/A</span>
            </div>
          </div>
        </div>

        <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‘ãƒãƒ« -->
        <div class="panel">
          <h3>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
          <div id="performance-metrics">
            <div class="metric-row">
              <span class="metric-label">å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼:</span>
              <span class="metric-value" id="avg-latency">N/A</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">æœ€å¤§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼:</span>
              <span class="metric-value" id="max-latency">N/A</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å•é¡Œ:</span>
              <span class="metric-value" id="focus-issues">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- è¨ºæ–­ã‚µãƒãƒªãƒ¼ -->
      <div class="panel full-width">
        <h3>ğŸ“‹ è¨ºæ–­ã‚µãƒãƒªãƒ¼</h3>
        <div id="diagnostic-summary" class="diagnostic-summary">
          è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„...
        </div>
      </div>

      <!-- ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
      <div class="panel full-width">
        <h3>â±ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
        <div id="event-timeline" class="event-timeline">ã‚¤ãƒ™ãƒ³ãƒˆå¾…æ©Ÿä¸­...</div>
      </div>

      <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° -->
      <div class="panel full-width">
        <h3>ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
        <div id="debug-log" class="log-container">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</div>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/player.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/input-diagnostic-system.js"></script>
    <script src="js/main.js"></script>

    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let gameEngine = null;
      let diagnosticSystem = null;
      let logMessages = [];
      let isRecording = false;
      let updateInterval = null;

      // ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®æ‹¡å¼µ
      const originalConsoleLog = console.log;
      const originalConsoleWarn = console.warn;
      const originalConsoleError = console.error;

      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        addLogMessage("INFO", args.join(" "));
      };

      console.warn = function (...args) {
        originalConsoleWarn.apply(console, args);
        addLogMessage("WARN", args.join(" "));
      };

      console.error = function (...args) {
        originalConsoleError.apply(console, args);
        addLogMessage("ERROR", args.join(" "));
      };

      function addLogMessage(level, message) {
        const timestamp = new Date().toLocaleTimeString();
        logMessages.push(`[${timestamp}] ${level}: ${message}`);

        // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
        if (logMessages.length > 100) {
          logMessages.shift();
        }

        updateDebugLog();
      }

      function updateDebugLog() {
        const logDiv = document.getElementById("debug-log");
        logDiv.textContent = logMessages.join("\n");
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
      async function initializeGame() {
        try {
          updateSystemStatus("engine-status", "åˆæœŸåŒ–ä¸­...", "warning");
          console.log("=== ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–é–‹å§‹ ===");

          const canvas = document.getElementById("game-canvas");
          canvas.style.display = "block";

          gameEngine = new GameEngine(canvas);
          const success = await gameEngine.init();

          if (success) {
            updateSystemStatus("engine-status", "æ­£å¸¸", "success");
            updateSystemStatus("input-status", "æ­£å¸¸", "success");
            updateSystemStatus("player-status", "æ­£å¸¸", "success");

            // è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
            diagnosticSystem = new InputDiagnosticSystem(
              gameEngine.inputManager,
              gameEngine.player
            );

            updateSystemStatus("diagnostic-status", "æº–å‚™å®Œäº†", "success");

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById("start-diag-btn").disabled = false;
            document.getElementById("test-btn").disabled = false;
            document.getElementById("self-diag-btn").disabled = false;

            // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
            gameEngine.start();
            gameEngine.startGame();

            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
            canvas.focus();

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
            startRealTimeUpdates();

            console.log("=== ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–å®Œäº† ===");
            showAlert(
              "ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¸ãƒ£ãƒ³ãƒ—ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚",
              "success"
            );
          } else {
            throw new Error("ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        } catch (error) {
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          updateSystemStatus("engine-status", "ã‚¨ãƒ©ãƒ¼", "error");
          showAlert(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
        }
      }

      // è¨ºæ–­é–‹å§‹
      function startDiagnostics() {
        if (!diagnosticSystem) {
          showAlert("è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
          return;
        }

        diagnosticSystem.startDiagnostics();
        isRecording = true;

        updateSystemStatus("diagnostic-status", "è¨˜éŒ²ä¸­", "warning");
        document.getElementById("start-diag-btn").disabled = true;
        document.getElementById("stop-diag-btn").disabled = false;

        console.log("ğŸ” è¨ºæ–­è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
        showAlert(
          "è¨ºæ–­è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¸ãƒ£ãƒ³ãƒ—ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚",
          "success"
        );
      }

      // è¨ºæ–­åœæ­¢
      function stopDiagnostics() {
        if (!diagnosticSystem || !isRecording) {
          return;
        }

        const report = diagnosticSystem.stopDiagnostics();
        isRecording = false;

        updateSystemStatus("diagnostic-status", "åˆ†æå®Œäº†", "success");
        document.getElementById("start-diag-btn").disabled = false;
        document.getElementById("stop-diag-btn").disabled = true;

        // ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
        displayDiagnosticReport(report);

        console.log("ğŸ” è¨ºæ–­è¨˜éŒ²ã‚’åœæ­¢ã—ã¾ã—ãŸ");
        console.log("ğŸ“Š è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ:", report);
        showAlert("è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "success");
      }

      // å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      async function runFullTest() {
        if (!diagnosticSystem) {
          showAlert("è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
          return;
        }

        console.log("ğŸ§ª å®Œå…¨ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™");
        showAlert("å®Œå…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...", "warning");

        // 1. å…¥åŠ›ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼
        const chainValidation = diagnosticSystem.validateInputChain();
        console.log("ğŸ”— å…¥åŠ›ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼:", chainValidation);

        // 2. ã‚¸ãƒ£ãƒ³ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        const jumpTest = diagnosticSystem.testJumpSequence();
        console.log("ğŸ¦˜ ã‚¸ãƒ£ãƒ³ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ:", jumpTest);

        // 3. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
        diagnosticSystem.startDiagnostics();

        for (let i = 0; i < 5; i++) {
          await new Promise((resolve) => setTimeout(resolve, 500));
          const simResult = diagnosticSystem.simulateSpaceKeyPress();
          console.log(`ğŸ¯ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ${i + 1}:`, simResult);
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));
        const finalReport = diagnosticSystem.stopDiagnostics();

        displayDiagnosticReport(finalReport);
        showAlert(
          "å®Œå…¨ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
          "success"
        );
      }

      // è‡ªå·±è¨ºæ–­å®Ÿè¡Œ
      function runSelfDiagnostic() {
        if (!diagnosticSystem) {
          showAlert("è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
          return;
        }

        console.log("ğŸ”§ è‡ªå·±è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¾ã™");
        showAlert("è‡ªå·±è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...", "warning");

        try {
          const selfDiagResult = diagnosticSystem.runSelfDiagnostic();
          console.log("ğŸ”§ è‡ªå·±è¨ºæ–­çµæœ:", selfDiagResult);

          // çµæœã‚’è¡¨ç¤º
          const summaryDiv = document.getElementById("diagnostic-summary");
          let html = `
            <div class="alert alert-${
              selfDiagResult.systemStatus === "healthy"
                ? "success"
                : selfDiagResult.systemStatus === "critical"
                ? "error"
                : "warning"
            }">
              <h4>ğŸ”§ è‡ªå·±è¨ºæ–­çµæœ</h4>
              <p><strong>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:</strong> ${
                selfDiagResult.systemStatus
              }</p>
              <p><strong>å®Ÿè¡Œæ™‚åˆ»:</strong> ${new Date(
                selfDiagResult.timestamp
              ).toLocaleString()}</p>
            </div>
          `;

          // ãƒã‚§ãƒƒã‚¯çµæœã‚’è¡¨ç¤º
          html += "<h4>ğŸ“‹ ãƒã‚§ãƒƒã‚¯çµæœ</h4>";
          selfDiagResult.checks.forEach((check) => {
            const statusClass =
              check.status === "passed"
                ? "success"
                : check.status === "failed"
                ? "error"
                : "warning";
            html += `
              <div class="alert alert-${statusClass}">
                <strong>${check.name}:</strong> ${check.message}
              </div>
            `;
          });

          // å•é¡ŒãŒã‚ã‚Œã°è¡¨ç¤º
          if (selfDiagResult.issues.length > 0) {
            html += "<h4>ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ</h4>";
            selfDiagResult.issues.forEach((issue) => {
              html += `
                <div class="alert alert-error">
                  ${issue}
                </div>
              `;
            });
          }

          // æ¨å¥¨äº‹é …ãŒã‚ã‚Œã°è¡¨ç¤º
          if (selfDiagResult.recommendations.length > 0) {
            html += "<h4>ğŸ’¡ æ¨å¥¨äº‹é …</h4>";
            selfDiagResult.recommendations.forEach((rec) => {
              html += `
                <div class="alert alert-success">
                  ${rec}
                </div>
              `;
            });
          }

          summaryDiv.innerHTML = html;
          showAlert("è‡ªå·±è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ", "success");
        } catch (error) {
          console.error("è‡ªå·±è¨ºæ–­ã‚¨ãƒ©ãƒ¼:", error);
          showAlert(
            "è‡ªå·±è¨ºæ–­ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message,
            "error"
          );
        }
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
      function clearAllData() {
        if (diagnosticSystem) {
          diagnosticSystem.reset();
        }

        logMessages = [];
        updateDebugLog();

        // çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById("space-count").textContent = "0";
        document.getElementById("jump-success").textContent = "0";
        document.getElementById("jump-failed").textContent = "0";
        document.getElementById("success-rate").textContent = "N/A";
        document.getElementById("avg-latency").textContent = "N/A";
        document.getElementById("max-latency").textContent = "N/A";
        document.getElementById("focus-issues").textContent = "0";

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
        document.getElementById("event-timeline").innerHTML =
          "ã‚¤ãƒ™ãƒ³ãƒˆå¾…æ©Ÿä¸­...";
        document.getElementById("diagnostic-summary").innerHTML =
          "è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„...";

        console.log("ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
        showAlert("å…¨ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ", "success");
      }

      // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
      function updateSystemStatus(elementId, status, type) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = status;
          element.className = `metric-value status-${type}`;
        }
      }

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
      function startRealTimeUpdates() {
        if (updateInterval) {
          clearInterval(updateInterval);
        }

        updateInterval = setInterval(() => {
          updateFocusStatus();
          updateInputStatistics();
          updateEventTimeline();
          updateEnhancedMetrics(); // æ–°ã—ã„æ‹¡å¼µãƒ¡ãƒˆãƒªã‚¯ã‚¹
        }, 100);
      }

      // æ‹¡å¼µãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ›´æ–°
      function updateEnhancedMetrics() {
        if (!diagnosticSystem) return;

        try {
          // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const dashboardData = diagnosticSystem.getDashboardData();

          // ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹çŠ¶æ…‹ã‚’æ›´æ–°
          if (dashboardData.status && dashboardData.status.systemHealth) {
            const healthStatus = dashboardData.status.systemHealth.overall;
            const healthElement = document.createElement("div");
            healthElement.className = `metric-row`;
            healthElement.innerHTML = `
              <span class="metric-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹:</span>
              <span class="metric-value status-${
                healthStatus === "good" ? "ok" : "warning"
              }">${healthStatus}</span>
            `;

            // æ—¢å­˜ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒ‘ãƒãƒ«ã«è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ä¸€åº¦ã ã‘ï¼‰
            const systemPanel = document.getElementById("system-status");
            if (systemPanel && !systemPanel.querySelector(".system-health")) {
              healthElement.classList.add("system-health");
              systemPanel.appendChild(healthElement);
            }
          }

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
          if (dashboardData.alerts && dashboardData.alerts.length > 0) {
            displayRealTimeAlerts(dashboardData.alerts);
          }

          // ãƒ©ã‚¤ãƒ–ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°
          if (dashboardData.metrics && dashboardData.metrics.liveMetrics) {
            updateLiveMetrics(dashboardData.metrics.liveMetrics);
          }
        } catch (error) {
          console.warn("Enhanced metrics update failed:", error);
        }
      }

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
      function displayRealTimeAlerts(alerts) {
        const summaryDiv = document.getElementById("diagnostic-summary");
        if (!summaryDiv) return;

        const alertsHtml = alerts
          .slice(0, 3)
          .map(
            (alert) => `
          <div class="alert alert-${
            alert.severity === "high" ? "error" : "warning"
          }">
            <strong>ğŸš¨ ${alert.type}:</strong> ${alert.message}<br>
            <em>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</em> ${alert.action}
          </div>
        `
          )
          .join("");

        if (alertsHtml) {
          summaryDiv.innerHTML =
            `<h4>ğŸš¨ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ</h4>${alertsHtml}` +
            summaryDiv.innerHTML;
        }
      }

      // ãƒ©ã‚¤ãƒ–ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°
      function updateLiveMetrics(liveMetrics) {
        // ã‚¤ãƒ™ãƒ³ãƒˆ/ç§’ã®è¡¨ç¤ºã‚’è¿½åŠ 
        const performancePanel = document.getElementById("performance-metrics");
        if (performancePanel && liveMetrics.eventsPerSecond) {
          let eventsPerSecElement =
            performancePanel.querySelector(".events-per-sec");
          if (!eventsPerSecElement) {
            eventsPerSecElement = document.createElement("div");
            eventsPerSecElement.className = "metric-row events-per-sec";
            performancePanel.appendChild(eventsPerSecElement);
          }
          eventsPerSecElement.innerHTML = `
            <span class="metric-label">ã‚¤ãƒ™ãƒ³ãƒˆ/ç§’:</span>
            <span class="metric-value">${liveMetrics.eventsPerSecond}</span>
          `;
        }

        // å…¥åŠ›å¿œç­”æ€§ã®è¡¨ç¤º
        if (performancePanel && liveMetrics.inputResponsiveness) {
          let responsivenessElement = performancePanel.querySelector(
            ".input-responsiveness"
          );
          if (!responsivenessElement) {
            responsivenessElement = document.createElement("div");
            responsivenessElement.className = "metric-row input-responsiveness";
            performancePanel.appendChild(responsivenessElement);
          }
          responsivenessElement.innerHTML = `
            <span class="metric-label">å…¥åŠ›å¿œç­”æ€§:</span>
            <span class="metric-value status-${
              liveMetrics.inputResponsiveness.status === "excellent"
                ? "ok"
                : "warning"
            }">
              ${liveMetrics.inputResponsiveness.status} (${
            liveMetrics.inputResponsiveness.score
          }%)
            </span>
          `;
        }
      }

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹æ›´æ–°
      function updateFocusStatus() {
        const hasFocus = document.hasFocus();
        const activeElement = document.activeElement;
        const canvas = document.getElementById("game-canvas");
        const canvasFocused = activeElement === canvas;

        document.getElementById("doc-focus").textContent = hasFocus
          ? "âœ… ã‚ã‚Š"
          : "âŒ ãªã—";
        document.getElementById("active-element").textContent =
          activeElement?.tagName || "ãªã—";
        document.getElementById("canvas-focus").textContent = canvasFocused
          ? "âœ… ã‚ã‚Š"
          : "âŒ ãªã—";
      }

      // å…¥åŠ›çµ±è¨ˆæ›´æ–°
      function updateInputStatistics() {
        if (!diagnosticSystem || !isRecording) return;

        const realTimeData = diagnosticSystem.getRealTimeDiagnostics();
        if (realTimeData.recording) {
          const stats = realTimeData.statistics;

          document.getElementById("space-count").textContent =
            stats.totalSpaceKeyEvents;
          document.getElementById("jump-success").textContent =
            stats.successfulJumps;
          document.getElementById("jump-failed").textContent =
            stats.failedJumps;

          const successRate =
            stats.totalSpaceKeyEvents > 0
              ? (
                  (stats.successfulJumps / stats.totalSpaceKeyEvents) *
                  100
                ).toFixed(1) + "%"
              : "N/A";
          document.getElementById("success-rate").textContent = successRate;

          document.getElementById("focus-issues").textContent =
            stats.focusIssues;
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ›´æ–°
      function updateEventTimeline() {
        if (!diagnosticSystem || !isRecording) return;

        const realTimeData = diagnosticSystem.getRealTimeDiagnostics();
        if (realTimeData.recording && realTimeData.recentEvents.length > 0) {
          const timeline = document.getElementById("event-timeline");
          const events = realTimeData.recentEvents.slice(-10); // æœ€æ–°10ä»¶

          timeline.innerHTML = events
            .map((event) => {
              const time = new Date(event.timestamp).toLocaleTimeString();
              const typeClass = `event-${event.type.replace("-", "-")}`;

              return `
                        <div class="event-item">
                            <div class="event-time">${time}</div>
                            <div class="event-type ${typeClass}">${
                event.type
              }</div>
                            <div class="event-details">${JSON.stringify(
                              event.data,
                              null,
                              2
                            )}</div>
                        </div>
                    `;
            })
            .join("");
        }
      }

      // è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
      function displayDiagnosticReport(report) {
        const summaryDiv = document.getElementById("diagnostic-summary");

        let html = `
                <div class="alert alert-${
                  report.issues.length === 0 ? "success" : "warning"
                }">
                    <h4>ğŸ“Š è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼</h4>
                    <p><strong>æœŸé–“:</strong> ${(
                      report.duration / 1000
                    ).toFixed(1)}ç§’</p>
                    <p><strong>ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°:</strong> ${
                      report.summary.totalEvents
                    }</p>
                    <p><strong>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼æŠ¼ä¸‹:</strong> ${
                      report.summary.spaceKeyEvents
                    }</p>
                    <p><strong>æˆåŠŸã‚¸ãƒ£ãƒ³ãƒ—:</strong> ${
                      report.summary.successfulJumps
                    }</p>
                    <p><strong>æˆåŠŸç‡:</strong> ${
                      report.summary.successRate
                    }</p>
                    <p><strong>å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼:</strong> ${report.summary.averageLatency.toFixed(
                      1
                    )}ms</p>
                </div>
            `;

        if (report.issues.length > 0) {
          html += "<h4>ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ</h4>";
          report.issues.forEach((issue) => {
            html += `
                        <div class="alert alert-${
                          issue.severity === "high" ? "error" : "warning"
                        }">
                            <strong>${issue.type}:</strong> ${
              issue.description
            }<br>
                            <em>å½±éŸ¿:</em> ${issue.impact}
                        </div>
                    `;
          });
        }

        if (report.recommendations.length > 0) {
          html += "<h4>ğŸ’¡ æ¨å¥¨äº‹é …</h4>";
          report.recommendations.forEach((rec) => {
            html += `
                        <div class="alert alert-success">
                            <strong>å„ªå…ˆåº¦ ${rec.priority}:</strong> ${rec.action}<br>
                            <em>è©³ç´°:</em> ${rec.details}
                        </div>
                    `;
          });
        }

        summaryDiv.innerHTML = html;

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°
        if (report.performance.totalLatency.average) {
          document.getElementById("avg-latency").textContent =
            report.performance.totalLatency.average.toFixed(1) + "ms";
          document.getElementById("max-latency").textContent =
            report.performance.totalLatency.max.toFixed(1) + "ms";
        }
      }

      // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
      function showAlert(message, type) {
        // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
        const existingAlert = document.querySelector(".temp-alert");
        if (existingAlert) {
          existingAlert.remove();
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} temp-alert`;
        alert.innerHTML = message;
        alert.style.position = "fixed";
        alert.style.top = "20px";
        alert.style.right = "20px";
        alert.style.zIndex = "1000";
        alert.style.maxWidth = "400px";

        document.body.appendChild(alert);

        // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 5000);
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          console.log("ğŸ” Raw Space keydown detected");
          event.preventDefault();
        }
      });

      document.addEventListener("keyup", (event) => {
        if (event.code === "Space") {
          console.log("ğŸ” Raw Space keyup detected");
        }
      });

      // Canvas ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
      document.addEventListener("click", (event) => {
        const canvas = document.getElementById("game-canvas");
        if (event.target === canvas) {
          canvas.focus();
          console.log("Canvas focused by click");
        }
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
      window.addEventListener("load", () => {
        console.log("ğŸš€ è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†");
        addLogMessage("INFO", "è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ");
      });

      // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      window.addEventListener("beforeunload", () => {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      });
    </script>
  </body>
</html>
