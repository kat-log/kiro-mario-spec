<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ä¿®æ­£ãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #1a1a1a;
        color: white;
        margin: 0;
      }
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .test-section {
        background: #333;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }
      .success {
        background: #4caf50;
      }
      .error {
        background: #f44336;
      }
      .warning {
        background: #ff9800;
      }
      .info {
        background: #2196f3;
      }

      #game-canvas {
        border: 2px solid #fff;
        border-radius: 5px;
        display: block;
        margin: 20px auto;
        background: #5c94fc;
      }

      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }

      button:hover {
        background: #45a049;
      }

      button:disabled {
        background: #666;
        cursor: not-allowed;
      }

      .log {
        background: #111;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ğŸ”§ ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>

      <div class="test-section">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
        <ol>
          <li>ã€Œã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¸ãƒ£ãƒ³ãƒ—ã‚’ãƒ†ã‚¹ãƒˆ</li>
          <li>ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§æ¬¡ã«é€²ã‚€ã‚’ãƒ†ã‚¹ãƒˆ</li>
        </ol>
      </div>

      <div class="test-section">
        <h3>ğŸ® ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
        <button onclick="initGame()" id="init-btn">ã‚²ãƒ¼ãƒ åˆæœŸåŒ–</button>
        <button onclick="startGame()" id="start-btn" disabled>
          ã‚²ãƒ¼ãƒ é–‹å§‹
        </button>
        <button onclick="testSpaceKey()">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>

        <canvas
          id="game-canvas"
          width="800"
          height="600"
          tabindex="0"
          style="display: none"
        >
          ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯HTML5 Canvasã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
        </canvas>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
        <div id="test-status" class="status info">ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</div>
      </div>

      <div class="test-section">
        <h3>ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
        <div id="debug-log" class="log">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="js/input-manager.js"></script>
    <script src="js/physics-engine.js"></script>
    <script src="js/player.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/item.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-system.js"></script>
    <script src="js/start-screen.js"></script>
    <script src="js/scene-manager.js"></script>
    <script src="js/settings-scene.js"></script>
    <script src="js/goal.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/stage-select-scene.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/integration-test.js"></script>
    <script src="js/system-validator.js"></script>
    <script src="js/test-runner.js"></script>
    <script src="js/browser-compatibility.js"></script>
    <script src="js/bug-detector.js"></script>
    <script src="js/usability-improvements.js"></script>
    <script src="js/main.js"></script>

    <script>
      let gameEngine = null;
      let logMessages = [];

      // ãƒ­ã‚°æ©Ÿèƒ½ã‚’æ‹¡å¼µ
      const originalConsoleLog = console.log;
      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        const message = args.join(" ");
        logMessages.push(`[${new Date().toLocaleTimeString()}] ${message}`);
        updateDebugLog();
      };

      function updateDebugLog() {
        const logDiv = document.getElementById("debug-log");
        logDiv.textContent = logMessages.slice(-50).join("\n"); // æœ€æ–°50ä»¶
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("test-status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }

      async function initGame() {
        try {
          updateStatus("ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...", "info");
          console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹ ===");

          const canvas = document.getElementById("game-canvas");
          canvas.style.display = "block";
          canvas.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š

          gameEngine = new GameEngine(canvas);
          const success = await gameEngine.init();

          if (success) {
            document.getElementById("start-btn").disabled = false;
            updateStatus("ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ", "success");
            console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº† ===");
          } else {
            updateStatus("ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
            console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å¤±æ•— ===");
          }
        } catch (error) {
          updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
          console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ ===", error);
        }
      }

      function startGame() {
        if (!gameEngine) {
          updateStatus("ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
          return;
        }

        try {
          console.log("=== ã‚²ãƒ¼ãƒ é–‹å§‹ ===");
          gameEngine.start();
          updateStatus(
            "ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¸ãƒ£ãƒ³ãƒ—ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚",
            "success"
          );

          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¢ºå®Ÿã«Canvasã«è¨­å®š
          const canvas = document.getElementById("game-canvas");
          canvas.focus();

          console.log("Canvas focused, ready for input");
        } catch (error) {
          updateStatus(`ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
          console.log("=== ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼ ===", error);
        }
      }

      function testSpaceKey() {
        console.log("=== ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼æ‰‹å‹•ãƒ†ã‚¹ãƒˆ ===");

        if (!gameEngine || !gameEngine.inputManager) {
          console.log("InputManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
          return;
        }

        const inputManager = gameEngine.inputManager;
        const debugInfo = inputManager.getDebugInfo();
        const playerInput = inputManager.getPlayerInput();

        console.log("ç¾åœ¨ã®ã‚­ãƒ¼çŠ¶æ…‹:", debugInfo.pressedKeys);
        console.log("ç¾åœ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:", debugInfo.activeActions);
        console.log("ã‚¸ãƒ£ãƒ³ãƒ—å…¥åŠ›:", playerInput.jump);
        console.log("ã‚¸ãƒ£ãƒ³ãƒ—ãƒ›ãƒ¼ãƒ«ãƒ‰:", playerInput.jumpHeld);

        // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®ç›´æ¥ãƒ†ã‚¹ãƒˆ
        const spaceHeld = inputManager.isKeyHeld("Space");
        const spacePressed = inputManager.isKeyPressed("Space");
        const jumpAction = inputManager.isActionPressed("jump");

        console.log(
          `Space held: ${spaceHeld}, pressed: ${spacePressed}, jump action: ${jumpAction}`
        );
      }

      function clearLog() {
        logMessages = [];
        updateDebugLog();
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          console.log(`ğŸ” Raw Space keydown detected: ${event.code}`);
          event.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
        }
      });

      document.addEventListener("keyup", (event) => {
        if (event.code === "Space") {
          console.log(`ğŸ” Raw Space keyup detected: ${event.code}`);
        }
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
      window.addEventListener("load", () => {
        console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");
        updateStatus(
          "ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ã€‚ã€Œã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚",
          "info"
        );
      });

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
      document.addEventListener("click", (event) => {
        if (event.target.id === "game-canvas") {
          console.log("Canvas clicked, focusing...");
          event.target.focus();
        }
      });
    </script>
  </body>
</html>
